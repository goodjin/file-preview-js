# 文件预览系统 - 架构设计文档

## 1. 架构概述

### 1.1 设计目标
- **模块化设计**：每个模块代码量不超过500行，便于多人协作开发和维护
- **高扩展性**：通过适配器模式支持45种文件格式，易于扩展新格式
- **高性能**：支持大文件（100MB+）预览，优化加载和渲染性能
- **纯前端方案**：不依赖服务端解析，所有处理在浏览器端完成

### 1.2 技术选型

#### 1.2.1 核心技术栈
- **语言**：JavaScript (ES6+)
- **构建工具**：Vite（快速开发体验）
- **包管理器**：npm / yarn
- **代码规范**：ESLint + Prettier
- **版本控制**：Git

#### 1.2.2 第三方库选择
```json
{
  "核心库": {
    "xlsx": "^0.18.5",           // Excel解析
    "pdf.js": "^3.11.174",       // PDF渲染
    "mammoth": "^1.6.0",         // Word解析
    "pptxgenjs": "^3.12.0",      // PowerPoint解析
    "jszip": "^3.10.1",          // ZIP解压
    "marked": "^9.1.6"           // Markdown解析
  },
  "渲染引擎": {
    "fabric.js": "^5.3.0"        // 画布操作（缩放、拖拽）
  },
  "工具库": {
    "file-saver": "^2.0.5",      // 文件下载
    "mime-types": "^2.1.35"      // MIME类型检测
  }
}
```

#### 1.2.3 技术约束
- 不使用后端服务进行文件解析
- 所有处理在浏览器端完成
- 兼容现代浏览器（Chrome 90+, Firefox 88+, Safari 14+, Edge 90+）
- 支持移动端和桌面端

### 1.3 设计模式应用
- **工厂模式**：PreviewerFactory - 根据文件类型创建对应的预览器
- **适配器模式**：Adapter层 - 统一不同文件格式的处理接口
- **策略模式**：FileTypeDetector - 多种文件类型检测策略
- **观察者模式**：EventBus - 模块间事件通信
- **单例模式**：StateManager - 全局状态管理

---

## 2. 模块架构设计

### 2.1 分层架构

```
┌─────────────────────────────────────────────────────┐
│                   UI展示层                           │
│  (顶部导航栏、预览容器、底部工具栏、消息提示组件)      │
├─────────────────────────────────────────────────────┤
│                  业务逻辑层                          │
│  (预览器管理、文件处理、状态管理、事件协调)           │
├─────────────────────────────────────────────────────┤
│                  适配器层                            │
│  (OfficeAdapter、DocumentAdapter、ImageAdapter...)   │
├─────────────────────────────────────────────────────┤
│                  核心框架层                          │
│  (PreviewerFactory、FileTypeDetector、EventBus)      │
├─────────────────────────────────────────────────────┤
│                  工具层                              │
│  (文件读取、类型检测、工具函数)                       │
└─────────────────────────────────────────────────────┘
```

### 2.2 核心模块划分

#### 2.2.1 核心框架层

##### Module 1: PreviewerFactory (预览器工厂)
**职责**：根据文件类型创建对应的预览器实例
**依赖**：FileTypeDetector
**文件路径**：`src/core/PreviewerFactory.js`

```javascript
// 模块接口
class PreviewerFactory {
  static create(file, options) {
    const fileType = FileTypeDetector.detect(file);
    return this.getPreviewerByType(fileType);
  }
}
```

##### Module 2: FileTypeDetector (文件类型检测器)
**职责**：快速检测文件类型（<100ms）
**依赖**：无
**文件路径**：`src/core/FileTypeDetector.js`

```javascript
// 模块接口
class FileTypeDetector {
  static detect(file) {
    // 1. 优先从文件扩展名判断
    // 2. 对可疑文件读取文件头魔数判断
    // 3. 返回标准化的文件类型标识
  }
}
```

##### Module 3: EventBus (事件总线)
**职责**：模块间事件通信，解耦模块依赖
**依赖**：无
**文件路径**：`src/core/EventBus.js`

```javascript
// 事件类型定义
const Events = {
  FILE_LOADED: 'file:loaded',
  PREVIEW_READY: 'preview:ready',
  ERROR_OCCURRED: 'error:occurred',
  ZOOM_CHANGED: 'zoom:changed',
  PAGE_CHANGED: 'page:changed'
};
```

##### Module 4: StateManager (状态管理器)
**职责**：管理全局状态（当前文件、缩放比例、页码等）
**依赖**：EventBus
**文件路径**：`src/core/StateManager.js`

```javascript
// 模块接口
class StateManager {
  getState(key) { /* ... */ }
  setState(key, value) { /* ... */ }
  subscribe(key, callback) { /* ... */ }
}
```

#### 2.2.2 适配器层

##### Module 5: OfficeAdapter (Office文档适配器)
**职责**：统一Office文档的预览接口
**支持的格式**：doc, docx, xls, xlsx, ppt, pptx, csv, wps, et, dps
**文件路径**：`src/adapters/OfficeAdapter.js`
**依赖库**：mammoth, xlsx, pptxgenjs

##### Module 6: DocumentAdapter (文档适配器)
**职责**：统一文档类文件的预览接口
**支持的格式**：pdf, ofd, rtf, txt, md, xml, json, epub
**文件路径**：`src/adapters/DocumentAdapter.js`
**依赖库**：pdf.js, marked

##### Module 7: ImageAdapter (图片适配器)
**职责**：统一图片文件的预览接口
**支持的格式**：jpg, png, gif, bmp, svg, tif, webp, psd
**文件路径**：`src/adapters/ImageAdapter.js`
**依赖**：无（使用浏览器原生能力）

##### Module 8: MediaAdapter (音视频适配器)
**职责**：统一音视频文件的预览接口
**支持的格式**：mp3, wav, mp4, flv, avi, mkv, webm
**文件路径**：`src/adapters/MediaAdapter.js`
**依赖**：无（使用浏览器原生能力）

##### Module 9: ArchiveAdapter (压缩包适配器)
**职责**：统一压缩包文件的预览接口
**支持的格式**：zip, rar, 7z, tar, gzip, jar
**文件路径**：`src/adapters/ArchiveAdapter.js`
**依赖库**：jszip

##### Module 10: OtherAdapter (其他格式适配器)
**职责**：特殊格式文件的预览接口
**支持的格式**：xmind, bpmn, drawio, eml, dcm
**文件路径**：`src/adapters/OtherAdapter.js`

#### 2.2.3 实现层

每个文件格式的具体预览实现，每个实现模块代码量不超过500行。

**Office格式实现**：
- `src/previewers/office/WordPreviewer.js` - doc/docx预览
- `src/previewers/office/ExcelPreviewer.js` - xls/xlsx/csv预览
- `src/previewers/office/PowerPointPreviewer.js` - ppt/pptx预览

**文档格式实现**：
- `src/previewers/document/PDFPreviewer.js` - pdf预览
- `src/previewers/document/TextPreviewer.js` - txt预览
- `src/previewers/document/MarkdownPreviewer.js` - md预览
- `src/previewers/document/CodePreviewer.js` - xml/json预览

**图片格式实现**：
- `src/previewers/image/ImagePreviewer.js` - 通用图片预览

**音视频格式实现**：
- `src/previewers/media/AudioPreviewer.js` - 音频预览
- `src/previewers/media/VideoPreviewer.js` - 视频预览

**压缩包格式实现**：
- `src/previewers/archive/ArchivePreviewer.js` - 压缩包预览

**特殊格式实现**：
- `src/previewers/other/SpecialPreviewer.js` - 特殊格式预览

#### 2.2.4 UI层

**组件路径**：`src/components/`

##### Module 11: NavBar (顶部导航栏)
**职责**：显示品牌标识、文件信息、全局操作按钮
**文件路径**：`src/components/NavBar.js`

##### Module 12: PreviewContainer (预览容器)
**职责**：主预览区域，承载具体预览器，处理缩放、拖拽等交互
**文件路径**：`src/components/PreviewContainer.js`

##### Module 13: Toolbar (底部工具栏)
**职责**：显示缩放控制、页面导航、下载、全屏等功能按钮
**文件路径**：`src/components/Toolbar.js`

##### Module 14: FileInfo (文件信息展示)
**职责**：显示文件名、文件大小、文件类型等信息
**文件路径**：`src/components/FileInfo.js`

##### Module 15: LoadingState (加载状态)
**职责**：显示文件加载进度和状态
**文件路径**：`src/components/LoadingState.js`

##### Module 16: Alert (提示框)
**职责**：显示成功、警告、错误提示
**文件路径**：`src/components/Alert.js`

### 2.3 模块依赖关系图

```
                    ┌─────────────┐
                    │   EventBus  │ (事件总线，核心通信基础设施)
                    └──────┬──────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
┌───────▼────────┐ ┌───────▼─────────┐ ┌──────▼─────────┐
│ StateManager   │ │PreviewerFactory │ │FileTypeDetector│
│ (状态管理)      │ │  (预览器工厂)   │ │  (类型检测)     │
└───────┬────────┘ └────────┬────────┘ └────────────────┘
        │                   │
        │            ┌──────▼─────────────────────────┐
        │            │   适配器层 (Adapters)           │
        │            ├────────────────────────────────┤
        │            │ OfficeAdapter, DocumentAdapter,│
        │            │ ImageAdapter, MediaAdapter,    │
        │            │ ArchiveAdapter, OtherAdapter   │
        │            └───────┬────────────────────────┘
        │                    │
        │            ┌───────▼────────────────────────┐
        │            │   实现层 (Previewers)          │
        │            ├────────────────────────────────┤
        │            │ WordPreviewer, ExcelPreviewer, │
        │            │ PDFPreviewer, ImagePreviewer,  │
        │            │ AudioPreviewer, VideoPreviewer,│
        │            │ ArchivePreviewer...           │
        │            └───────┬────────────────────────┘
        │                    │
        │            ┌───────▼────────────────────────┐
        │            │      UI层 (Components)         │
        │            ├────────────────────────────────┤
        │            │ NavBar, PreviewContainer,     │
        │            │ Toolbar, FileInfo, Alert...   │
        │            └────────────────────────────────┘
        │
┌───────▼────────────────────────────────┐
│      主入口 (App.js)                    │
└─────────────────────────────────────────┘
```

---

## 3. 模块接口定义

### 3.1 核心框架层接口

#### 3.1.1 PreviewerFactory 接口

```javascript
/**
 * 预览器工厂
 * 根据文件类型创建对应的预览器实例
 */
class PreviewerFactory {
  /**
   * 创建预览器实例
   * @param {File} file - 文件对象
   * @param {Object} options - 预览选项
   * @returns {Previewer} 预览器实例
   */
  static create(file, options) {
    // 实现逻辑
  }

  /**
   * 根据文件类型获取预览器
   * @param {string} fileType - 文件类型
   * @returns {Previewer} 预览器实例
   */
  static getPreviewerByType(fileType) {
    // 实现逻辑
  }

  /**
   * 注册新的预览器类型
   * @param {string} fileType - 文件类型
   * @param {Previewer} previewerClass - 预览器类
   */
  static register(fileType, previewerClass) {
    // 实现逻辑
  }
}
```

#### 3.1.2 FileTypeDetector 接口

```javascript
/**
 * 文件类型检测器
 * 快速检测文件类型（目标：<100ms）
 */
class FileTypeDetector {
  /**
   * 检测文件类型
   * @param {File} file - 文件对象
   * @returns {string} 文件类型标识
   */
  static detect(file) {
    // 1. 优先从扩展名判断
    const ext = this.getExtension(file.name);
    if (ext) return ext;

    // 2. 读取文件头魔数判断（针对可疑文件）
    return this.detectByMagicNumber(file);
  }

  /**
   * 获取文件扩展名
   * @param {string} fileName - 文件名
   * @returns {string|null} 扩展名
   */
  static getExtension(fileName) {
    // 实现逻辑
  }

  /**
   * 通过文件头魔数检测类型
   * @param {File} file - 文件对象
   * @returns {Promise<string>} 文件类型
   */
  static async detectByMagicNumber(file) {
    // 实现逻辑
  }
}
```

#### 3.1.3 EventBus 接口

```javascript
/**
 * 事件总线
 * 模块间事件通信，解耦模块依赖
 */
class EventBus {
  constructor() {
    this.events = {};
  }

  /**
   * 订阅事件
   * @param {string} event - 事件名称
   * @param {Function} callback - 回调函数
   * @returns {Function} 取消订阅函数
   */
  on(event, callback) {
    // 实现逻辑
  }

  /**
   * 触发事件
   * @param {string} event - 事件名称
   * @param {*} data - 事件数据
   */
  emit(event, data) {
    // 实现逻辑
  }

  /**
   * 取消订阅
   * @param {string} event - 事件名称
   * @param {Function} callback - 回调函数
   */
  off(event, callback) {
    // 实现逻辑
  }

  /**
   * 订阅一次性事件
   * @param {string} event - 事件名称
   * @param {Function} callback - 回调函数
   */
  once(event, callback) {
    // 实现逻辑
  }
}

// 事件类型常量
const Events = {
  // 文件事件
  FILE_LOADED: 'file:loaded',
  FILE_LOAD_PROGRESS: 'file:load:progress',
  FILE_LOAD_ERROR: 'file:load:error',

  // 预览事件
  PREVIEW_READY: 'preview:ready',
  PREVIEW_ERROR: 'preview:error',

  // 交互事件
  ZOOM_CHANGED: 'zoom:changed',
  PAGE_CHANGED: 'page:changed',
  FULLSCREEN_TOGGLE: 'fullscreen:toggle',

  // 应用事件
  APP_READY: 'app:ready',
  APP_ERROR: 'app:error'
};
```

#### 3.1.4 StateManager 接口

```javascript
/**
 * 状态管理器
 * 管理全局状态
 */
class StateManager {
  constructor(eventBus) {
    this.state = {};
    this.eventBus = eventBus;
  }

  /**
   * 获取状态
   * @param {string} key - 状态键
   * @returns {*} 状态值
   */
  getState(key) {
    return this.state[key];
  }

  /**
   * 设置状态
   * @param {string} key - 状态键
   * @param {*} value - 状态值
   */
  setState(key, value) {
    const oldValue = this.state[key];
    this.state[key] = value;
    this.eventBus.emit(`state:${key}`, { oldValue, newValue: value });
  }

  /**
   * 订阅状态变化
   * @param {string} key - 状态键
   * @param {Function} callback - 回调函数
   * @returns {Function} 取消订阅函数
   */
  subscribe(key, callback) {
    return this.eventBus.on(`state:${key}`, callback);
  }
}

// 预定义状态键
const StateKeys = {
  CURRENT_FILE: 'currentFile',
  FILE_TYPE: 'fileType',
  ZOOM_LEVEL: 'zoomLevel',
  CURRENT_PAGE: 'currentPage',
  TOTAL_PAGES: 'totalPages',
  LOADING: 'loading',
  ERROR: 'error'
};
```

### 3.2 适配器层接口

#### 3.2.1 BaseAdapter 接口（基类）

```javascript
/**
 * 适配器基类
 * 所有适配器必须继承此类
 */
class BaseAdapter {
  /**
   * 检查是否支持该文件类型
   * @param {string} fileType - 文件类型
   * @returns {boolean} 是否支持
   */
  static supports(fileType) {
    throw new Error('Method must be implemented');
  }

  /**
   * 加载文件
   * @param {File} file - 文件对象
   * @returns {Promise<Object>} 加载结果
   */
  async load(file) {
    throw new Error('Method must be implemented');
  }

  /**
   * 渲染预览
   * @param {HTMLElement} container - 容器元素
   * @param {Object} data - 加载的数据
   * @returns {Promise<void>}
   */
  async render(container, data) {
    throw new Error('Method must be implemented');
  }

  /**
   * 销毁预览器
   */
  destroy() {
    // 清理资源
  }
}
```

#### 3.2.2 OfficeAdapter 接口

```javascript
/**
 * Office文档适配器
 * 支持：doc, docx, xls, xlsx, ppt, pptx, csv, wps, et, dps
 */
class OfficeAdapter extends BaseAdapter {
  static supportedTypes = ['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'csv', 'wps', 'et', 'dps'];

  static supports(fileType) {
    return this.supportedTypes.includes(fileType);
  }

  async load(file) {
    const ext = FileTypeDetector.getExtension(file.name);

    // 根据扩展名选择对应的加载方式
    switch (ext) {
      case 'doc':
      case 'docx':
        return this.loadWord(file);
      case 'xls':
      case 'xlsx':
      case 'csv':
        return this.loadExcel(file);
      case 'ppt':
      case 'pptx':
        return this.loadPowerPoint(file);
      default:
        throw new Error(`Unsupported Office type: ${ext}`);
    }
  }

  async loadWord(file) {
    // 使用 mammoth 库解析 Word 文档
  }

  async loadExcel(file) {
    // 使用 xlsx 库解析 Excel 文档
  }

  async loadPowerPoint(file) {
    // 使用 pptxgenjs 库解析 PowerPoint 文档
  }

  async render(container, data) {
    // 根据数据类型渲染内容
  }
}
```

#### 3.2.3 DocumentAdapter 接口

```javascript
/**
 * 文档适配器
 * 支持：pdf, ofd, rtf, txt, md, xml, json, epub
 */
class DocumentAdapter extends BaseAdapter {
  static supportedTypes = ['pdf', 'ofd', 'rtf', 'txt', 'md', 'xml', 'json', 'epub'];

  static supports(fileType) {
    return this.supportedTypes.includes(fileType);
  }

  async load(file) {
    const ext = FileTypeDetector.getExtension(file.name);

    switch (ext) {
      case 'pdf':
        return this.loadPDF(file);
      case 'txt':
        return this.loadText(file);
      case 'md':
        return this.loadMarkdown(file);
      case 'xml':
      case 'json':
        return this.loadCode(file);
      default:
        throw new Error(`Unsupported document type: ${ext}`);
    }
  }

  async loadPDF(file) {
    // 使用 pdf.js 渲染 PDF
  }

  async loadText(file) {
    // 读取纯文本文件
  }

  async loadMarkdown(file) {
    // 使用 marked 解析 Markdown
  }

  async loadCode(file) {
    // 高亮显示代码
  }

  async render(container, data) {
    // 渲染文档内容
  }
}
```

### 3.3 UI层组件接口

#### 3.3.1 PreviewContainer 组件接口

```javascript
/**
 * 预览容器组件
 * 承载具体预览器，处理缩放、拖拽等交互
 */
class PreviewContainer {
  constructor(options) {
    this.options = {
      zoom: 1,
      minZoom: 0.1,
      maxZoom: 5,
      enableZoom: true,
      enablePan: true,
      ...options
    };
    this.zoomLevel = this.options.zoom;
    this.isPanning = false;
    this.lastMousePosition = { x: 0, y: 0 };
  }

  /**
   * 设置文件内容
   * @param {HTMLElement} content - 内容元素
   */
  setContent(content) {
    // 设置预览内容
  }

  /**
   * 设置缩放比例
   * @param {number} zoom - 缩放比例
   */
  setZoom(zoom) {
    // 设置缩放
    this.zoomLevel = Math.max(this.options.minZoom, Math.min(this.options.maxZoom, zoom));
    this.render();
  }

  /**
   * 放大
   */
  zoomIn() {
    this.setZoom(this.zoomLevel * 1.2);
  }

  /**
   * 缩小
   */
  zoomOut() {
    this.setZoom(this.zoomLevel / 1.2);
  }

  /**
   * 重置缩放
   */
  resetZoom() {
    this.setZoom(1);
  }

  /**
   * 渲染
   */
  render() {
    // 应用变换
  }

  /**
   * 销毁
   */
  destroy() {
    // 清理事件监听器
  }
}
```

#### 3.3.2 Toolbar 组件接口

```javascript
/**
 * 工具栏组件
 * 显示缩放控制、页面导航、下载、全屏等功能按钮
 */
class Toolbar {
  constructor(options) {
    this.options = {
      showZoom: true,
      showPageNav: false,
      showFullscreen: true,
      showDownload: true,
      showPrint: false,
      ...options
    };
    this.callbacks = {};
  }

  /**
   * 设置总页数
   * @param {number} totalPages - 总页数
   */
  setTotalPages(totalPages) {
    // 设置总页数
  }

  /**
   * 设置当前页码
   * @param {number} currentPage - 当前页码
   */
  setCurrentPage(currentPage) {
    // 设置当前页码
  }

  /**
   * 设置缩放比例
   * @param {number} zoom - 缩放比例
   */
  setZoom(zoom) {
    // 设置缩放比例
  }

  /**
   * 显示页面导航
   */
  showPageNavigation() {
    this.options.showPageNav = true;
    this.render();
  }

  /**
   * 隐藏页面导航
   */
  hidePageNavigation() {
    this.options.showPageNav = false;
    this.render();
  }

  /**
   * 注册事件回调
   * @param {string} event - 事件名称
   * @param {Function} callback - 回调函数
   */
  on(event, callback) {
    this.callbacks[event] = callback;
  }

  /**
   * 销毁
   */
  destroy() {
    // 清理DOM和事件监听
  }
}
```

---

## 4. 文件夹结构设计

### 4.1 项目目录结构

```
file-preview-js/
├── docs/                           # 文档目录
│   ├── PRD.md                      # 产品需求文档
│   ├── UI设计文档.md                # UI设计文档
│   ├── 组件规范文档.md              # 组件规范文档
│   └── 架构设计.md                  # 架构设计文档（本文件）
│
├── public/                         # 静态资源
│   ├── index.html                  # 入口HTML
│   ├── favicon.ico                 # 网站图标
│   └── assets/                     # 公共资源
│       ├── icons/                  # 图标资源
│       └── images/                 # 图片资源
│
├── src/                            # 源代码目录
│   ├── index.js                    # 应用入口
│   │
│   ├── core/                       # 核心框架层
│   │   ├── PreviewerFactory.js     # 预览器工厂
│   │   ├── FileTypeDetector.js     # 文件类型检测器
│   │   ├── EventBus.js             # 事件总线
│   │   └── StateManager.js         # 状态管理器
│   │
│   ├── adapters/                   # 适配器层
│   │   ├── BaseAdapter.js          # 适配器基类
│   │   ├── OfficeAdapter.js         # Office文档适配器
│   │   ├── DocumentAdapter.js      # 文档适配器
│   │   ├── ImageAdapter.js         # 图片适配器
│   │   ├── MediaAdapter.js         # 音视频适配器
│   │   ├── ArchiveAdapter.js       # 压缩包适配器
│   │   └── OtherAdapter.js         # 其他格式适配器
│   │
│   ├── previewers/                 # 实现层（具体预览器）
│   │   ├── office/                 # Office格式预览器
│   │   │   ├── WordPreviewer.js    # Word预览器
│   │   │   ├── ExcelPreviewer.js   # Excel预览器
│   │   │   └── PowerPointPreviewer.js # PowerPoint预览器
│   │   │
│   │   ├── document/               # 文档格式预览器
│   │   │   ├── PDFPreviewer.js     # PDF预览器
│   │   │   ├── TextPreviewer.js    # 文本预览器
│   │   │   ├── MarkdownPreviewer.js # Markdown预览器
│   │   │   └── CodePreviewer.js    # 代码预览器
│   │   │
│   │   ├── image/                  # 图片格式预览器
│   │   │   └── ImagePreviewer.js   # 通用图片预览器
│   │   │
│   │   ├── media/                  # 音视频格式预览器
│   │   │   ├── AudioPreviewer.js   # 音频预览器
│   │   │   └── VideoPreviewer.js   # 视频预览器
│   │   │
│   │   ├── archive/                # 压缩包格式预览器
│   │   │   └── ArchivePreviewer.js # 压缩包预览器
│   │   │
│   │   └── other/                  # 特殊格式预览器
│   │       └── SpecialPreviewer.js  # 特殊格式预览器
│   │
│   ├── components/                 # UI组件
│   │   ├── NavBar.js               # 顶部导航栏
│   │   ├── PreviewContainer.js     # 预览容器
│   │   ├── Toolbar.js              # 底部工具栏
│   │   ├── FileInfo.js             # 文件信息展示
│   │   ├── LoadingState.js         # 加载状态
│   │   ├── Alert.js                # 提示框
│   │   ├── Button.js               # 按钮组件
│   │   ├── Icon.js                 # 图标组件
│   │   └── Tooltip.js              # 工具提示
│   │
│   ├── utils/                      # 工具函数
│   │   ├── fileUtils.js            # 文件处理工具
│   │   ├── formatUtils.js          # 格式化工具
│   │   ├── domUtils.js             # DOM操作工具
│   │   └── validator.js            # 验证工具
│   │
│   ├── constants/                  # 常量定义
│   │   ├── fileTypes.js            # 文件类型常量
│   │   ├── events.js               # 事件常量
│   │   └── config.js               # 配置常量
│   │
│   └── styles/                     # 样式文件
│       ├── index.css               # 全局样式
│       ├── variables.css           # CSS变量
│       ├── components.css          # 组件样式
│       └── utilities.css           # 工具类
│
├── tests/                          # 测试目录
│   ├── unit/                       # 单元测试
│   │   ├── core/                   # 核心层测试
│   │   ├── adapters/               # 适配器层测试
│   │   ├── previewers/             # 实现层测试
│   │   └── components/             # 组件测试
│   │
│   ├── integration/                # 集成测试
│   │   └── preview.test.js         # 预览集成测试
│   │
│   └── e2e/                        # 端到端测试
│       └── main.test.js            # E2E测试
│
├── examples/                       # 示例目录
│   ├── basic/                      # 基础示例
│   └── advanced/                   # 高级示例
│
├── .gitignore                      # Git忽略文件
├── .eslintrc.js                    # ESLint配置
├── .prettierrc                     # Prettier配置
├── package.json                    # 项目配置
├── vite.config.js                  # Vite配置
├── README.md                       # 项目说明
└── LICENSE                         # 许可证
```

### 4.2 代码组织原则

1. **模块化**：每个文件只包含一个主要的类或组件
2. **职责单一**：每个模块只负责一个明确的功能
3. **依赖清晰**：依赖关系单向，避免循环依赖
4. **可测试**：每个模块都应该易于测试

---

## 5. 开发优先级与版本规划

### 5.1 版本迭代规划

#### v0.1.0 - 核心框架 + P0格式（第一阶段）
**时间计划**：2周

**开发内容**：
1. 核心框架层
   - PreviewerFactory
   - FileTypeDetector
   - EventBus
   - StateManager

2. P0格式预览
   - Office：docx, xlsx, pptx
   - 文档：pdf
   - 图片：jpg, png, gif

3. 基础UI组件
   - NavBar
   - PreviewContainer
   - Toolbar
   - LoadingState

**交付标准**：
- 核心框架层功能完整
- P0格式预览正常工作
- 基础UI界面完成
- 通过单元测试

#### v0.2.0 - P1格式支持（第二阶段）
**时间计划**：2周

**开发内容**：
1. P1格式预览
   - Office：doc, xls, ppt, csv
   - 文档：txt, md, xml, json
   - 音视频：mp3, mp4
   - 压缩包：zip, 7z, tar

2. 扩展功能
   - 文件下载
   - 全屏预览
   - 打印功能

**交付标准**：
- P1格式预览正常工作
- 扩展功能完成
- 通过集成测试

#### v0.3.0 - P2格式支持（第三阶段）
**时间计划**：3周

**开发内容**：
1. P2格式预览
   - 国产格式：wps, et, dps, ofd
   - 更多图片：bmp, svg, webp, psd, tif
   - 更多音视频：wav, flv, avi, mkv, webm
   - 其他压缩：rar, gzip, jar

2. 性能优化
   - 大文件加载优化
   - 渲染性能优化

**交付标准**：
- P2格式预览正常工作
- 性能优化完成
- 支持大文件（100MB+）

#### v1.0.0 - 全部格式支持 + 正式发布（第四阶段）
**时间计划**：2周

**开发内容**：
1. P3格式预览
   - 特殊格式：xmind, bpmn, drawio, eml, dcm
   - 其他：rtf, epub

2. 完善功能
   - 响应式设计完善
   - 无障碍支持
   - 用户体验优化

3. 文档完善
   - API文档
   - 使用指南
   - 开发指南

**交付标准**：
- 全部45种格式支持完成
- 通过完整测试
- 文档完善
- 正式发布

### 5.2 文件格式开发优先级

| 优先级 | 格式分类 | 格式列表 | 开发阶段 |
|--------|----------|----------|----------|
| P0 | Office | docx, xlsx, pptx | v0.1.0 |
| P0 | 文档 | pdf | v0.1.0 |
| P0 | 图片 | jpg, png, gif | v0.1.0 |
| P1 | Office | doc, xls, ppt, csv | v0.2.0 |
| P1 | 文档 | txt, md, xml, json | v0.2.0 |
| P1 | 音视频 | mp3, mp4 | v0.2.0 |
| P1 | 压缩包 | zip, 7z, tar | v0.2.0 |
| P2 | 国产Office | wps, et, dps | v0.3.0 |
| P2 | 文档 | ofd | v0.3.0 |
| P2 | 图片 | bmp, svg, webp, psd, tif | v0.3.0 |
| P2 | 音视频 | wav, flv, avi, mkv, webm | v0.3.0 |
| P2 | 压缩包 | rar, gzip, jar | v0.3.0 |
| P3 | 特殊格式 | xmind, bpmn, drawio, eml, dcm | v1.0.0 |
| P3 | 其他 | rtf, epub | v1.0.0 |

---

## 6. 数据流转与消息流程

### 6.1 文件加载流程

```
┌─────────┐
│  用户   │
└────┬────┘
     │ 1. 选择文件
     ▼
┌─────────────────┐
│  UI层 (App)     │
└────┬────────────┘
     │ 2. 调用 PreviewerFactory.create(file)
     ▼
┌─────────────────────────┐
│  PreviewerFactory       │
└────┬────────────────────┘
     │ 3. 调用 FileTypeDetector.detect(file)
     ▼
┌─────────────────────────┐
│  FileTypeDetector       │
└────┬────────────────────┘
     │ 4. 返回文件类型
     ▼
┌─────────────────────────┐
│  PreviewerFactory       │
└────┬────────────────────┘
     │ 5. 根据类型选择对应Adapter
     ▼
┌─────────────────────────┐
│  OfficeAdapter (示例)   │
└────┬────────────────────┘
     │ 6. 调用 adapter.load(file)
     ▼
┌─────────────────────────┐
│  WordPreviewer (示例)   │
└────┬────────────────────┘
     │ 7. 解析文件数据
     ▼
┌─────────────────────────┐
│  EventBus.emit          │
│  'file:loaded'          │
└────┬────────────────────┘
     │ 8. 通知UI层
     ▼
┌─────────────────────────┐
│  PreviewContainer       │
└────┬────────────────────┘
     │ 9. 渲染预览内容
     ▼
┌─────────────────────────┐
│  显示预览内容           │
└─────────────────────────┘
```

### 6.2 缩放控制流程

```
┌─────────┐
│  用户   │
└────┬────┘
     │ 1. 点击放大/缩小按钮
     ▼
┌─────────────────┐
│  Toolbar        │
└────┬────────────┘
     │ 2. 触发 callback('zoom:in')
     ▼
┌─────────────────────────┐
│  PreviewContainer       │
└────┬────────────────────┘
     │ 3. 调用 setZoom(zoomLevel)
     ▼
┌─────────────────────────┐
│  EventBus.emit          │
│  'zoom:changed'         │
└────┬────────────────────┘
     │ 4. 更新 StateManager
     ▼
┌─────────────────────────┐
│  StateManager           │
└────┬────────────────────┘
     │ 5. 通知所有订阅者
     ▼
┌─────────────────┐  ┌──────────────┐
│  Toolbar        │  │  PreviewView │
│ (更新缩放显示)  │  │ (应用缩放)   │
└─────────────────┘  └──────────────┘
```

### 6.3 错误处理流程

```
┌─────────────────────────┐
│  预览器 (Previewer)     │
└────┬────────────────────┘
     │ 1. 发生错误
     ▼
┌─────────────────────────┐
│  EventBus.emit          │
│  'error:occurred'       │
└────┬────────────────────┘
     │ 2. 传播错误事件
     ▼
┌─────────────────────────┐
│  StateManager           │
└────┬────────────────────┘
     │ 3. 更新 error 状态
     ▼
┌─────────────────┐
│  Alert组件      │
│ (显示错误提示)  │
└─────────────────┘
```

---

## 7. 性能优化设计

### 7.1 文件加载优化

#### 7.1.1 大文件分块加载
```javascript
/**
 * 分块读取大文件
 * @param {File} file - 文件对象
 * @param {number} chunkSize - 每块大小（默认 1MB）
 * @returns {AsyncGenerator<Uint8Array>} 分块数据生成器
 */
async function* readFileInChunks(file, chunkSize = 1024 * 1024) {
  const fileSize = file.size;
  let offset = 0;

  while (offset < fileSize) {
    const chunk = file.slice(offset, offset + chunkSize);
    const buffer = await chunk.arrayBuffer();
    offset += chunkSize;
    yield new Uint8Array(buffer);
  }
}
```

#### 7.1.2 进度显示
```javascript
// 使用 FileReader 监听进度
const reader = new FileReader();
reader.onprogress = (event) => {
  if (event.lengthComputable) {
    const progress = (event.loaded / event.total) * 100;
    EventBus.emit('file:load:progress', { progress });
  }
};
```

### 7.2 渲染优化

#### 7.2.1 虚拟滚动（适用于长文档）
```javascript
// 只渲染可视区域的内容
class VirtualScroll {
  constructor(container, itemHeight, renderItem) {
    this.container = container;
    this.itemHeight = itemHeight;
    this.renderItem = renderItem;
    this.visibleItems = new Set();
  }

  render(totalItems, scrollTop) {
    const containerHeight = this.container.clientHeight;
    const startIdx = Math.floor(scrollTop / this.itemHeight);
    const endIdx = Math.ceil((scrollTop + containerHeight) / this.itemHeight);

    // 只渲染可见项
    for (let i = startIdx; i <= endIdx; i++) {
      if (!this.visibleItems.has(i)) {
        const element = this.renderItem(i);
        this.container.appendChild(element);
        this.visibleItems.add(i);
      }
    }

    // 移除不可见项
    for (const idx of this.visibleItems) {
      if (idx < startIdx || idx > endIdx) {
        const element = this.container.children[idx - startIdx];
        if (element) {
          element.remove();
          this.visibleItems.delete(idx);
        }
      }
    }
  }
}
```

#### 7.2.2 图片懒加载
```javascript
// 使用 IntersectionObserver 实现懒加载
class LazyImageLoader {
  constructor(options = {}) {
    this.observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const img = entry.target;
          img.src = img.dataset.src;
          this.observer.unobserve(img);
        }
      });
    }, options);
  }

  observe(element) {
    this.observer.observe(element);
  }

  disconnect() {
    this.observer.disconnect();
  }
}
```

### 7.3 内存优化

#### 7.3.1 资源释放
```javascript
class Previewer {
  destroy() {
    // 清理 DOM 元素
    this.container.innerHTML = '';

    // 释放 Blob URL
    if (this.blobUrl) {
      URL.revokeObjectURL(this.blobUrl);
      this.blobUrl = null;
    }

    // 取消事件监听
    this.eventBus.off(this.eventListeners);
  }
}
```

#### 7.3.2 图片缓存限制
```javascript
class ImageCache {
  constructor(maxSize = 10) {
    this.cache = new Map();
    this.maxSize = maxSize;
  }

  set(key, value) {
    if (this.cache.size >= this.maxSize) {
      // 删除最旧的项
      const firstKey = this.cache.keys().next().value;
      this.cache.delete(firstKey);
    }
    this.cache.set(key, value);
  }

  get(key) {
    const value = this.cache.get(key);
    if (value) {
      // 移到最后，表示最近使用
      this.cache.delete(key);
      this.cache.set(key, value);
    }
    return value;
  }
}
```

---

## 8. 团队协作流程

### 8.1 岗位分工

#### 8.1.1 模块负责人

根据模块划分，设立以下模块负责人：

1. **核心框架负责人**
   - 负责：PreviewerFactory、FileTypeDetector、EventBus、StateManager
   - 交付：完整的核心框架层代码 + 单元测试

2. **Office模块负责人**
   - 负责：OfficeAdapter + Word/Excel/PowerPoint预览器
   - 交付：Office格式预览功能 + 测试

3. **文档模块负责人**
   - 负责：DocumentAdapter + PDF/Text/Markdown/Code预览器
   - 交付：文档格式预览功能 + 测试

4. **媒体模块负责人**
   - 负责：ImageAdapter、MediaAdapter + 图片/音视频预览器
   - 交付：媒体格式预览功能 + 测试

5. **压缩包模块负责人**
   - 负责：ArchiveAdapter + ArchivePreviewer
   - 交付：压缩包格式预览功能 + 测试

6. **UI组件负责人**
   - 负责：所有UI组件
   - 交付：完整的UI组件库 + 样式系统

7. **集成测试负责人**
   - 负责：集成测试、E2E测试
   - 交付：完整的测试套件

8. **体验官**
   - 负责：用户体验测试、问题反馈
   - 交付：用户体验报告

### 8.2 协作流程

#### 8.2.1 需求确认流程
```
产品经理 → 系统架构师 → 模块负责人 → 程序员
```

#### 8.2.2 开发流程
1. **架构设计阶段**（已完成）
   - 系统架构师设计整体架构
   - 输出架构设计文档

2. **模块开发阶段**
   - 模块负责人根据架构设计进行模块详细设计
   - 程序员负责具体代码实现
   - 每个模块代码量不超过500行

3. **集成阶段**
   - 各模块完成后进行集成
   - 集成测试负责人进行集成测试

4. **测试阶段**
   - 质检员进行代码质量检查
   - 体验官进行用户体验测试

5. **发布阶段**
   - 修复所有已知问题
   - 准备发布

#### 8.2.3 代码规范
- 使用 ESLint + Prettier 统一代码风格
- 所有代码必须有注释
- 每个模块必须有单元测试
- 测试覆盖率不低于 80%

#### 8.2.4 Git工作流
```
main (主分支)
  ↓
develop (开发分支)
  ↓
feature/xxx (功能分支)
  ↓ (开发完成)
develop
  ↓ (集成测试通过)
release/v0.1.0 (发布分支)
  ↓
main
```

### 8.3 交付标准

#### 8.3.1 代码交付标准
- 代码通过 ESLint 检查
- 单元测试通过
- 代码有完整的注释
- 模块接口符合架构设计

#### 8.3.2 文档交付标准
- 每个模块有 README 说明
- API 文档完整
- 使用示例清晰

#### 8.3.3 测试交付标准
- 单元测试覆盖率 ≥ 80%
- 集成测试通过
- E2E测试通过
- 用户体验测试通过

---

## 9. 编码风格与规范

### 9.1 命名规范

```javascript
// 类名：PascalCase
class PreviewerFactory {
  // ...
}

// 函数名：camelCase
function detectFileType(file) {
  // ...
}

// 常量：UPPER_SNAKE_CASE
const MAX_FILE_SIZE = 100 * 1024 * 1024; // 100MB

// 私有方法：前缀下划线
class Previewer {
  _loadFile() {
    // ...
  }
}
```

### 9.2 注释规范

```javascript
/**
 * 预览器工厂
 * 根据文件类型创建对应的预览器实例
 *
 * @class PreviewerFactory
 */
class PreviewerFactory {
  /**
   * 创建预览器实例
   *
   * @param {File} file - 文件对象
   * @param {Object} options - 预览选项
   * @param {number} [options.zoom=1] - 初始缩放比例
   * @param {boolean} [options.enableZoom=true] - 是否启用缩放
   * @returns {Previewer} 预览器实例
   * @throws {Error} 当文件类型不支持时抛出异常
   */
  static create(file, options = {}) {
    // 实现代码
  }
}
```

### 9.3 错误处理规范

```javascript
// 使用 try-catch 捕获异常
async loadFile(file) {
  try {
    const data = await this._parseFile(file);
    return data;
  } catch (error) {
    // 记录错误
    console.error('Failed to load file:', error);

    // 通知错误
    this.eventBus.emit('error:occurred', {
      error,
      message: 'Failed to load file'
    });

    // 抛出异常
    throw error;
  }
}
```

---

## 10. 测试策略

### 10.1 单元测试

每个模块都必须有单元测试，使用 Jest 或 Mocha。

```javascript
// FileTypeDetector.test.js
import { FileTypeDetector } from '../src/core/FileTypeDetector';

describe('FileTypeDetector', () => {
  it('should detect file type by extension', () => {
    const file = new File([''], 'test.pdf', { type: 'application/pdf' });
    const type = FileTypeDetector.detect(file);
    expect(type).toBe('pdf');
  });

  it('should detect Office document types', () => {
    const types = ['docx', 'xlsx', 'pptx'];
    types.forEach(type => {
      const file = new File([''], `test.${type}`);
      const detected = FileTypeDetector.detect(file);
      expect(detected).toBe(type);
    });
  });
});
```

### 10.2 集成测试

测试模块之间的协作。

```javascript
// preview.integration.test.js
import { PreviewerFactory } from '../src/core/PreviewerFactory';
import { EventBus } from '../src/core/EventBus';

describe('Preview Integration', () => {
  it('should load and preview a PDF file', async () => {
    const eventBus = new EventBus();
    const file = new File([pdfData], 'test.pdf', { type: 'application/pdf' });

    const previewer = PreviewerFactory.create(file);

    let loaded = false;
    eventBus.on('file:loaded', () => {
      loaded = true;
    });

    await previewer.load(file);
    expect(loaded).toBe(true);
  });
});
```

### 10.3 E2E测试

使用 Cypress 或 Playwright 进行端到端测试。

```javascript
// main.e2e.test.js
describe('File Preview E2E', () => {
  it('should preview a PDF file', () => {
    cy.visit('/');
    cy.get('input[type="file"]').attachFile('test.pdf');
    cy.get('.preview-container').should('be.visible');
    cy.get('.pdf-page').should('have.length', 5);
  });
});
```

---

## 11. 部署与运行环境

### 11.1 开发环境

```bash
# 安装依赖
npm install

# 启动开发服务器
npm run dev

# 运行测试
npm test

# 代码检查
npm run lint
```

### 11.2 生产构建

```bash
# 构建生产版本
npm run build

# 预览生产构建
npm run preview
```

### 11.3 部署方案

本项目为纯前端方案，可以部署到任何静态文件托管服务：

- GitHub Pages
- Vercel
- Netlify
- AWS S3 + CloudFront
- 阿里云 OSS + CDN

---

## 12. 总结

本架构设计文档定义了文件预览系统的完整技术架构，包括：

1. **技术选型**：JavaScript + Vite，纯前端方案
2. **模块划分**：核心框架层、适配器层、实现层、UI层
3. **接口定义**：每个模块的清晰接口规范
4. **开发优先级**：分4个阶段完成45种文件格式支持
5. **性能优化**：大文件加载、渲染优化、内存优化
6. **团队协作**：模块分工、协作流程、交付标准
7. **测试策略**：单元测试、集成测试、E2E测试

架构设计遵循以下原则：
- **模块化**：每个模块代码量不超过500行
- **高内聚低耦合**：模块职责清晰，依赖关系明确
- **可扩展性**：易于扩展新的文件格式
- **高性能**：支持大文件（100MB+）预览
- **易维护**：清晰的代码规范和文档

---

**文档版本**: 1.0
**编写日期**: 2024
**编写者**: 系统架构师
**审核状态**: 待审核