# Excel解析器技术调研文档

## 1. Office Open XML规范概述

### 1.1 规范来源
- **ECMA-376**：Office Open XML文件格式标准
- **ISO/IEC 29500**：国际化标准
- XLSX是Excel 2007+使用的默认格式

### 1.2 核心特点
- 基于ZIP打包的XML文档
- 开放文档格式，规范公开
- 支持多种数据类型和复杂样式
- 兼容性好，跨平台

## 2. XLSX文件结构

### 2.1 ZIP包结构
典型的XLSX文件包含以下文件：

```
example.xlsx
├── [Content_Types].xml          # 内容类型定义
├── _rels/                      # 关系目录
│   └── .rels                  # 包级关系
├── xl/                         # 工作簿目录
│   ├── _rels/                  # 工作簿关系
│   │   └── workbook.xml.rels
│   ├── workbook.xml             # 工作簿定义
│   ├── worksheets/             # 工作表目录
│   │   ├── sheet1.xml
│   │   ├── sheet2.xml
│   │   └── ...
│   ├── sharedStrings.xml        # 共享字符串表
│   ├── styles.xml              # 样式定义
│   ├── theme/                  # 主题
│   │   └── theme1.xml
│   └── media/                 # 媒体文件（图片等）
└── docProps/                   # 文档属性
    ├── app.xml
    └── core.xml
```

### 2.2 关键文件说明

#### [Content_Types].xml
定义ZIP包中各部分的MIME类型，包括：
- XML文档类型：`application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml`
- 工作表类型：`application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml`
- 共享字符串：`application/vnd.openxmlformats-officedocument.spreadsheetml.sharedStrings+xml`
- 样式：`application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml`

#### workbook.xml
- 定义工作簿结构
- 列出所有工作表
- 定义工作表之间的关系

示例结构：
```xml
<workbook xmlns="...">
  <sheets>
    <sheet name="Sheet1" sheetId="1" r:id="rId1"/>
    <sheet name="Sheet2" sheetId="2" r:id="rId2"/>
  </sheets>
</workbook>
```

#### worksheets/sheet*.xml
包含工作表的实际数据：
- `<sheetData>`：单元格数据
- `<row>`：行元素
- `<c>`：单元格元素
- `<v>`：单元格值

#### sharedStrings.xml
存储所有文本字符串，用于优化存储和减少重复：
- 每个字符串有一个唯一的索引
- 单元格通过索引引用字符串
- 大幅减少文件大小

示例：
```xml
<sst xmlns="..." count="10" uniqueCount="8">
  <si><t>张三</t></si>
  <si><t>李四</t></si>
  <si><t>王五</t></si>
</sst>
```

#### styles.xml
定义单元格样式：
- `<cellXfs>`：单元格格式
- `<fonts>`：字体定义
- `<fills>`：填充（背景色）
- `<borders>`：边框
- `<numFmts>`：数字格式

## 3. 单元格数据结构

### 3.1 单元格元素（`<c>`）
```xml
<c r="A1" t="s">    <!-- t="s" 表示共享字符串 -->
  <v>0</v>          <!-- 引用sharedStrings的索引 -->
</c>

<c r="B1" t="n">    <!-- t="n" 表示数字 -->
  <v>123.45</v>
</c>

<c r="C1">          <!-- 无t属性表示字符串 -->
  <v>直接文本</v>
</c>

<c r="D1" t="b">    <!-- t="b" 表示布尔值 -->
  <v>1</v>          <!-- 1=true, 0=false -->
</c>

<c r="E1" t="str">   <!-- t="str" 表示公式字符串 -->
  <f>SUM(A1:A10)</f>
  <v>结果值</v>
</c>
```

### 3.2 单元格类型（t属性）
- `s`：共享字符串（Shared String）
- `n`：数字（Number）
- `b`：布尔值（Boolean）
- `e`：错误（Error）
- `str`：字符串（String）
- `inlineStr`：内联字符串
- 不设置：自动推断类型

### 3.3 单元格引用（r属性）
- `A1`：列A行1
- `B10`：列B行10
- `Z100`：列Z行100

列名转换算法：
- A=0, B=1, ..., Z=25
- AA=26, AB=27, ...
- 公式：`value = sum(char - 'A' + 1) * 26^position`

## 4. 公式处理

### 4.1 公式元素
```xml
<c r="C1">
  <f>SUM(A1:B2)</f>    <!-- 公式 -->
  <v>150</v>            <!-- 计算结果（可选） -->
</c>

<c r="D1">
  <f ref="A1:A10" t="array">SUM(A1:A10)</f>  <!-- 数组公式 -->
</c>
```

### 4.2 常用公式函数（V1.0范围）
- 数学函数：SUM, AVERAGE, MAX, MIN, COUNT, ROUND, ABS
- 逻辑函数：IF, AND, OR, NOT
- 文本函数：LEFT, RIGHT, MID, LEN, CONCAT, UPPER, LOWER
- 日期函数：TODAY, NOW, DATE, YEAR, MONTH, DAY
- 查找函数：VLOOKUP, HLOOKUP, INDEX, MATCH
- 统计函数：COUNTA, COUNTIF, SUMIF

## 5. 样式处理

### 5.1 样式引用
```xml
<c r="A1" s="0">    <!-- s属性引用样式索引 -->
  <v>值</v>
</c>
```

### 5.2 V1.0支持的样式属性
- **字体**：字体名称、字号、颜色、粗体、斜体、下划线
- **对齐**：水平对齐、垂直对齐、自动换行
- **填充**：背景色
- **边框**：边框样式、边框颜色（简化为基本边框）
- **数字格式**：常规、数字、货币、百分比、日期、时间

### 5.3 样式结构
```xml
<styleSheet xmlns="...">
  <fonts count="1">
    <font><b val="1"/><sz val="11"/><color theme="1"/></font>
  </fonts>
  <fills count="1">
    <fill><patternFill patternType="solid"><fgColor theme="0"/></patternFill></fill>
  </fills>
  <cellXfs count="2">
    <xf numFmtId="0" fontId="0" fillId="0" borderId="0"/>
    <xf numFmtId="0" fontId="0" fillId="0" borderId="0" applyFont="1"/>
  </cellXfs>
</styleSheet>
```

## 6. 多工作表处理

### 6.1 工作表关系
```xml
<!-- workbook.xml.rels -->
<Relationships xmlns="...">
  <Relationship Id="rId1" 
    Type="http://.../worksheet" 
    Target="worksheets/sheet1.xml"/>
  <Relationship Id="rId2" 
    Type="http://.../worksheet" 
    Target="worksheets/sheet2.xml"/>
</Relationships>
```

### 6.2 工作表信息
```xml
<!-- workbook.xml -->
<sheets>
  <sheet name="Sheet1" sheetId="1" r:id="rId1"/>
  <sheet name="Sheet2" sheetId="2" r:id="rId2"/>
</sheets>
```

## 7. 图片处理

### 7.1 图片存储
- 图片文件存储在`xl/media/`目录
- 图片关系定义在`xl/worksheets/_rels/sheet*.xml.rels`
- 绘图信息在`xl/drawings/`目录

### 7.2 图片引用
```xml
<drawing r:id="rId1"/>  <!-- 引用drawing关系 -->
```

## 8. 技术难点分析

### 8.1 难点1：SharedStrings的高效处理
**问题**：大文件中SharedStrings可能包含成千上万条字符串
**解决方案**：
- 一次性加载并建立索引
- 使用Map结构快速查找
- 考虑懒加载（按需读取）

### 8.2 难点2：公式计算引擎
**问题**：公式计算复杂，依赖关系可能形成循环引用
**解决方案**：
- V1.0实现基础公式解析和计算
- 优先支持常用函数（SUM, AVERAGE, IF等）
- 不强制计算，优先使用Excel保存的结果值

### 8.3 难点3：日期和时间格式
**问题**：Excel使用序列号表示日期，需要转换
**解决方案**：
- Excel日期：1 = 1900-01-01
- 转换公式：`date = new Date((excelDate - 25569) * 86400 * 1000)`
- 处理1900闰年bug（Excel认为1900是闰年）

### 8.4 难点4：稀疏数据优化
**问题**：工作表可能只有少量单元格有数据
**解决方案**：
- 使用稀疏矩阵存储
- 按需加载单元格数据
- 跳过大片空白区域

## 9. 参考资源

### 9.1 官方规范
- ECMA-376: https://www.ecma-international.org/publications-and-standards/standards/ecma-376/
- ISO/IEC 29500: 国际标准组织

### 9.2 开源实现参考（仅了解，不直接使用代码）
- SheetJS (xlsx): 成熟的开源库
- ExcelJS: Node.js的Excel处理库
- OpenXML SDK: 微软官方SDK

### 9.3 调试工具
- 7-Zip: 解压XLSX文件查看结构
- Excel: 创建测试文件对比验证
- XML编辑器: 查看XML内容

## 10. 技术调研结论

### 10.1 可行性评估
✅ **技术可行性**：完全可行
- ZIP解析已实现
- XML解析可使用浏览器原生DOMParser
- 规范公开，文档完整

### 10.2 V1.0实现范围
**核心功能**：
- ✅ 解析XLSX文件结构
- ✅ 提取单元格数据（字符串、数字、布尔值）
- ✅ 解析SharedStrings
- ✅ 处理多工作表
- ✅ 解析基础样式（字体、颜色、对齐）
- ✅ 提取公式（但不计算）

**限制**：
- ⚠️ 不计算公式结果，使用Excel保存的值
- ⚠️ 样式处理简化（不支持复杂条件格式）
- ⚠️ 不支持合并单元格
- ⚠️ 图片提取但不渲染

### 10.3 性能预估
- **小文件**（< 1MB）：解析时间 < 500ms
- **中等文件**（1-10MB）：解析时间 < 2s
- **大文件**（> 10MB）：解析时间 < 5s

### 10.4 内存占用
- 预估内存占用：文件大小的2-3倍
- 优化方案：按需加载、释放不再使用的数据

---

**调研日期**：2026-02-09
**调研人员**：程序员（Excel解析器）
**文档版本**：v1.0
