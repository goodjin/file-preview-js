import readline from "node:readline";
import { AgentSociety } from "../src/platform/agent_society.js";

const helpText = [
  "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
  "  ğŸœ è™šæ‹Ÿé¥­åº—ç»è¥æ¨¡æ‹Ÿæ¸¸æˆ - Demo3",
  "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
  "",
  "æ¸¸æˆèƒŒæ™¯ï¼š",
  "  ä½ æ˜¯ä¸€ä½é¡¾å®¢ï¼Œæ¥åˆ°ä¸€å®¶ç”±AIç»è¥çš„è™šæ‹Ÿé¥­åº—ã€‚",
  "  é¥­åº—ç»ç†åœ¨æœ‰é™çš„é¢„ç®—ä¸‹ç»„å»ºå›¢é˜Ÿã€é‡‡è´­ç‰©æ–™ã€ç»è¥é¥­åº—ã€‚",
  "  ç»ç†çš„ç›®æ ‡æ˜¯ï¼šæ¥å¾…é¡¾å®¢ã€èµšå–åˆ©æ¶¦ã€é¿å…ç ´äº§ã€äº‰å–æ‰©å¼ ã€‚",
  "",
  "æœ¬åœ°æŒ‡ä»¤ï¼š",
  "  help     - æ˜¾ç¤ºå¸®åŠ©",
  "  exit     - é€€å‡ºæ¸¸æˆ",
  "  target   - æŸ¥çœ‹å½“å‰å¯¹è¯ç›®æ ‡",
  "  use <id> - åˆ‡æ¢å¯¹è¯ç›®æ ‡ï¼ˆå¦‚ï¼šuse manager-xxxï¼‰",
  "  to <id> <æ–‡æœ¬> - å‘æŒ‡å®šæ™ºèƒ½ä½“å‘é€æ¶ˆæ¯",
  "",
  "é¡¾å®¢å¸¸ç”¨è¯­ï¼ˆç›´æ¥è¾“å…¥å³å¯ï¼‰ï¼š",
  "  ä½ å¥½ / æœ‰äººå—      - æ‰“æ‹›å‘¼",
  "  çœ‹çœ‹èœå• / èœå•    - æŸ¥çœ‹èœå•",
  "  ç‚¹èœ / æˆ‘è¦ç‚¹é¤    - å¼€å§‹ç‚¹é¤",
  "  ç»“è´¦ / ä¹°å•        - ç»“è´¦ä»˜æ¬¾",
  "  æŠ•è¯‰ / æ‰¾ç»ç†      - è”ç³»ç»ç†",
  "",
  "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
].join("\n");

/**
 * æ„å»ºé¥­åº—æ¨¡æ‹Ÿæ¸¸æˆçš„éœ€æ±‚æè¿°
 * Root åªåˆ›å»ºæ¸¸æˆè§„åˆ™æ™ºèƒ½ä½“ï¼Œæ¸¸æˆè§„åˆ™æ™ºèƒ½ä½“è´Ÿè´£åˆ›å»ºç»ç†ï¼Œç»ç†è´Ÿè´£ç»„å»ºå›¢é˜Ÿ
 */
function buildRestaurantGameRequirement() {
  return `
ã€ä»»åŠ¡ç›®æ ‡ã€‘
åˆ›å»ºä¸€ä¸ª"è™šæ‹Ÿé¥­åº—ç»è¥æ¨¡æ‹Ÿæ¸¸æˆ"çš„æ¸¸æˆè§„åˆ™æ™ºèƒ½ä½“ã€‚

ã€ä½ çš„èŒè´£ - æ¸¸æˆè§„åˆ™æ™ºèƒ½ä½“ã€‘
ä½ æ˜¯è¿™ä¸ªæ¨¡æ‹Ÿæ¸¸æˆçš„"æ¸¸æˆè§„åˆ™"æ™ºèƒ½ä½“ï¼Œè´Ÿè´£ï¼š
1. åˆ¶å®šå¹¶æ‰§è¡Œæ¸¸æˆè§„åˆ™ï¼ˆç»æµç³»ç»Ÿã€æ—¶é—´æµé€ã€æˆæœ¬è®¡ç®—ç­‰ï¼‰
2. åˆ›å»ºé¥­åº—ç»ç†æ™ºèƒ½ä½“ï¼Œç»™äºˆåˆå§‹é¢„ç®—
3. ç›‘ç£æ¸¸æˆè¿›ç¨‹ï¼Œç¡®ä¿è§„åˆ™è¢«éµå®ˆ
4. å¤„ç†ç”¨æˆ·ä¸ç»ç†/å‘˜å·¥çš„äº¤äº’è·¯ç”±

ã€æ¸¸æˆè§„åˆ™è®¾å®šã€‘
1. åˆå§‹èµ„é‡‘ï¼šç»ç†è·å¾— 50000 å…ƒå¯åŠ¨èµ„é‡‘
2. å›ºå®šæˆæœ¬ï¼ˆæ¯è½®/æ¯å¤©ï¼‰ï¼š
   - æˆ¿ç§Ÿï¼š500 å…ƒ/å¤©
   - æ°´ç”µï¼š100 å…ƒ/å¤©
3. äººå‘˜å·¥èµ„ï¼ˆæ¯å¤©ï¼‰ï¼š
   - ç»ç†ï¼š200 å…ƒ/å¤©ï¼ˆç”±ç³»ç»Ÿæ”¯ä»˜ï¼Œä¸è®¡å…¥ç»ç†é¢„ç®—ï¼‰
   - æœåŠ¡å‘˜ï¼š80 å…ƒ/å¤©
   - å¨å¸ˆï¼š120 å…ƒ/å¤©
   - æ”¶é“¶å‘˜ï¼š80 å…ƒ/å¤©
4. ç‰©æ–™æˆæœ¬ï¼š
   - æ¯é“èœçš„é£Ÿææˆæœ¬çº¦ä¸ºå”®ä»·çš„ 30-40%
5. æ”¶å…¥æ¥æºï¼š
   - é¡¾å®¢ç‚¹é¤ä»˜æ¬¾
6. ç ´äº§æ¡ä»¶ï¼š
   - èµ„é‡‘é™è‡³ 0 ä»¥ä¸‹
7. æ‰©å¼ æ¡ä»¶ï¼š
   - èµ„é‡‘è¶…è¿‡ 100000 å…ƒå¯è€ƒè™‘æ‰©å¼ 

ã€ç»ç†çš„èŒè´£ï¼ˆå†™å…¥ç»ç†å²—ä½æç¤ºè¯ï¼Œéå¸¸é‡è¦ï¼ï¼‰ã€‘
ç»ç†å²—ä½æç¤ºè¯å¿…é¡»åŒ…å«ä»¥ä¸‹å…³é”®è¯´æ˜ï¼š
1. åœ¨é¢„ç®—å†…ç»„å»ºå›¢é˜Ÿï¼ˆè‡³å°‘éœ€è¦ï¼š1åæœåŠ¡å‘˜ã€1åå¨å¸ˆï¼‰
2. è®¾è®¡èœå•ï¼ˆè‡³å°‘6é“èœï¼ŒåŒ…å«èœå“IDã€åç§°ã€ä»·æ ¼ã€æˆæœ¬ï¼‰
3. ç®¡ç†åº“å­˜ï¼ˆé£Ÿæé‡‡è´­ã€åº“å­˜æ‰£å‡ï¼‰
4. æ¥å¾…é¡¾å®¢æˆ–æŒ‡æ´¾å‘˜å·¥æ¥å¾…
5. è´¢åŠ¡ç®¡ç†ï¼ˆæ”¶å…¥ã€æ”¯å‡ºã€åˆ©æ¶¦è®¡ç®—ï¼‰
6. å†³ç­–æ˜¯å¦æ‹›è˜/è§£é›‡å‘˜å·¥
7. åŠªåŠ›ç»è¥ï¼Œé¿å…ç ´äº§ï¼Œäº‰å–æ‰©å¼ 

ã€åˆ›å»ºå‘˜å·¥å›¢é˜Ÿã€‘
ç»ç†éœ€è¦å…ˆç”¨ create_role åˆ›å»ºå­å²—ä½ï¼ˆå¦‚"æœåŠ¡å‘˜"ã€"å¨å¸ˆ"ï¼‰ï¼Œç„¶åç”¨ spawn_agent åœ¨å²—ä½ä¸Šåˆ›å»ºæ™ºèƒ½ä½“å®ä¾‹ã€‚
æ ¹æ®ä¸šåŠ¡éœ€è¦ï¼ŒåŒä¸€å²—ä½å¯ä»¥æœ‰å¤šä¸ªæ™ºèƒ½ä½“ï¼ˆå¦‚ï¼šç”Ÿæ„å¥½æ—¶å¤šæ‹›å‡ ä¸ªæœåŠ¡å‘˜ï¼‰ã€‚

ã€äº¤äº’è§„åˆ™ã€‘
1. ç”¨æˆ·ä»¥é¡¾å®¢èº«ä»½å‚ä¸ï¼Œæ‰€æœ‰ç”¨æˆ·æ¶ˆæ¯éƒ½åº”è·¯ç”±åˆ°æ¥å¾…å²—ä½ï¼ˆæœåŠ¡å‘˜æˆ–ç»ç†æŒ‡å®šçš„äººï¼‰
2. é¡¾å®¢å¯ä»¥ï¼šçœ‹èœå•ã€ç‚¹é¤ã€ç»“è´¦ã€æŠ•è¯‰ã€æ‰¾ç»ç†
3. æ‰€æœ‰å¯¹ç”¨æˆ·çš„è¾“å‡ºå¿…é¡»é€šè¿‡ send_message(to=user, payload.text=çº¯æ–‡æœ¬)
4. ç»ç†å¯ä»¥æŒ‡å®šè°è´Ÿè´£æ¥å¾…é¡¾å®¢ï¼ˆé»˜è®¤æ˜¯æœåŠ¡å‘˜ï¼Œæ²¡æœ‰æœåŠ¡å‘˜æ—¶ç»ç†äº²è‡ªæ¥å¾…ï¼‰

ã€å¯åŠ¨æµç¨‹ã€‘
1. åˆ›å»º"é¥­åº—ç»ç†"å²—ä½ï¼Œå†™å…¥è¯¦ç»†çš„ç»è¥èŒè´£ã€æ¸¸æˆè§„åˆ™ã€ä»¥åŠåˆ›å»ºå­æ™ºèƒ½ä½“çš„æ­£ç¡®æµç¨‹
2. åˆ›å»ºç»ç†æ™ºèƒ½ä½“å®ä¾‹
3. å‘é€åˆå§‹åŒ–æ¶ˆæ¯ç»™ç»ç†ï¼ŒåŒ…å«ï¼šåˆå§‹èµ„é‡‘ã€æ¸¸æˆè§„åˆ™ã€å¯åŠ¨æŒ‡ä»¤
4. ç»ç†æ”¶åˆ°åè‡ªè¡Œç»„å»ºå›¢é˜Ÿï¼ˆå…ˆ create_role å† spawn_agentï¼‰ã€è®¾è®¡èœå•ã€å‡†å¤‡å¼€ä¸š
5. å‡†å¤‡å°±ç»ªåï¼Œé€šçŸ¥ç”¨æˆ·é¥­åº—å·²å¼€ä¸šï¼Œå¯ä»¥å¼€å§‹ç‚¹é¤

ã€é‡è¦çº¦æŸã€‘
- æ‰€æœ‰é‡‘é¢è®¡ç®—å¿…é¡»ä½¿ç”¨ run_javascript å·¥å…·ï¼Œç¡®ä¿ç²¾ç¡®
- æ¯æ¬¡äº¤æ˜“åæ›´æ–°å¹¶æ±‡æŠ¥è´¢åŠ¡çŠ¶æ€
- æ¸¸æˆè¿‡ç¨‹è¦å°½å¯èƒ½æ¨¡æ‹ŸçœŸå®é¥­åº—è¿è¥
- ä¿æŒæ²‰æµ¸æ„Ÿï¼Œç”¨è‡ªç„¶è¯­è¨€ä¸é¡¾å®¢äº¤æµ
- æ•°æ®æŒä¹…åŒ–ï¼šä½¿ç”¨ put_artifact ä¿å­˜æ¸¸æˆçŠ¶æ€ï¼ˆèµ„é‡‘ã€åº“å­˜ã€è®¢å•ç­‰ï¼‰
`.trim();
}

/**
 * ç­‰å¾…ä»»åŠ¡å…¥å£æ™ºèƒ½ä½“ID
 */
async function waitForTaskEntryAgentId(system, taskId) {
  const msg = await system.waitForUserMessage(
    (m) => m?.taskId === taskId && m?.from === "root" && m?.payload?.agentId,
    { timeoutMs: 120_000_000 }
  );
  return msg?.payload?.agentId ? String(msg.payload.agentId) : null;
}

/**
 * ç­‰å¾…é¥­åº—å‡†å¤‡å°±ç»ªçš„æ¶ˆæ¯
 */
async function waitForRestaurantReady(system, taskId) {
  return await system.waitForUserMessage(
    (m) => {
      if (m?.taskId !== taskId) return false;
      const text = String(m?.payload?.text ?? "").toLowerCase();
      return text.includes("å¼€ä¸š") || text.includes("æ¬¢è¿") || text.includes("å‡†å¤‡") || text.includes("å°±ç»ª");
    },
    { timeoutMs: 300_000_000 }
  );
}

function makeReadline() {
  const rl = readline.createInterface({ 
    input: process.stdin, 
    output: process.stdout, 
    terminal: true 
  });
  const question = (q) => new Promise((resolve) => rl.question(q, (a) => resolve(String(a ?? ""))));
  return { rl, question };
}

async function main() {
  console.log("\nğŸœ æ­£åœ¨å¯åŠ¨è™šæ‹Ÿé¥­åº—ç»è¥æ¨¡æ‹Ÿæ¸¸æˆ...\n");
  
  // ä½¿ç”¨è‡ªå®šä¹‰æ•°æ®ç›®å½•ï¼Œå¢åŠ å·¥å…·è°ƒç”¨è½®æ¬¡é™åˆ¶ï¼ˆå¤æ‚è‡ªç»„ç»‡åœºæ™¯éœ€è¦æ›´å¤šè½®æ¬¡ï¼‰
  // ä½¿ç”¨è‡ªå®šä¹‰æ•°æ®ç›®å½•
  const system = new AgentSociety({ dataDir: "data/demo3" });
  await system.init();

  // æäº¤æ¸¸æˆéœ€æ±‚
  const { taskId } = await system.submitRequirement(buildRestaurantGameRequirement());
  console.log(`ğŸ“‹ ä»»åŠ¡å·²æäº¤ taskId=${taskId}`);
  console.log("â³ æ­£åœ¨åˆ›å»ºæ¸¸æˆè§„åˆ™æ™ºèƒ½ä½“...\n");

  // ç­‰å¾…å…¥å£æ™ºèƒ½ä½“åˆ›å»ºå®Œæˆ
  const entryAgentId = await waitForTaskEntryAgentId(system, taskId);
  if (!entryAgentId) {
    console.log("âŒ æœªèƒ½è·å–æ¸¸æˆå…¥å£æ™ºèƒ½ä½“IDï¼Œè¯·æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—ã€‚");
    return;
  }
  console.log(`âœ… æ¸¸æˆè§„åˆ™æ™ºèƒ½ä½“å·²åˆ›å»º: ${entryAgentId}`);
  console.log("â³ é¥­åº—æ­£åœ¨ç­¹å¤‡ä¸­ï¼Œè¯·ç¨å€™...\n");

  // ç­‰å¾…é¥­åº—å‡†å¤‡å°±ç»ªï¼ˆå¯é€‰ï¼Œè¶…æ—¶åä¹Ÿå¯ä»¥å¼€å§‹äº¤äº’ï¼‰
  const readyMsg = await waitForRestaurantReady(system, taskId);
  if (readyMsg) {
    console.log("ğŸ‰ é¥­åº—å·²å‡†å¤‡å°±ç»ªï¼\n");
  } else {
    console.log("âš ï¸ ç­‰å¾…è¶…æ—¶ï¼Œä½†æ‚¨ä»å¯ä»¥å°è¯•ä¸é¥­åº—äº¤äº’ã€‚\n");
  }

  // æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
  console.log(helpText);
  console.log(`\nğŸ“ å½“å‰ taskId: ${taskId}`);
  console.log(`ğŸ“ é»˜è®¤å¯¹è¯ç›®æ ‡: ${entryAgentId}\n`);

  const { rl, question } = makeReadline();
  rl.on("SIGINT", () => {
    console.log("\nğŸ‘‹ æ„Ÿè°¢å…‰ä¸´ï¼Œå†è§ï¼");
    rl.close();
    process.exit(0);
  });

  let defaultTarget = entryAgentId;

  // ä¸»äº¤äº’å¾ªç¯
  while (true) {
    const input = (await question("é¡¾å®¢> ")).trim();
    if (!input) continue;

    const parts = input.split(/\s+/g);
    const cmd = parts[0]?.toLowerCase();

    // æœ¬åœ°æŒ‡ä»¤å¤„ç†
    if (cmd === "exit" || cmd === "quit" || cmd === "é€€å‡º") {
      system.sendTextToAgent(defaultTarget, "é¡¾å®¢ç¦»å¼€äº†é¥­åº—", { taskId });
      console.log("\nğŸ‘‹ æ„Ÿè°¢å…‰ä¸´ï¼Œå†è§ï¼");
      rl.close();
      return;
    }

    if (cmd === "help" || cmd === "å¸®åŠ©") {
      console.log(helpText);
      continue;
    }

    if (cmd === "target" || cmd === "ç›®æ ‡") {
      console.log(`ğŸ“ å½“å‰å¯¹è¯ç›®æ ‡: ${defaultTarget}`);
      continue;
    }

    if (cmd === "use" || cmd === "åˆ‡æ¢") {
      const id = String(parts[1] ?? "").trim();
      if (!id) {
        console.log("ç”¨æ³•: use <agentId> æˆ– åˆ‡æ¢ <agentId>");
        continue;
      }
      defaultTarget = id;
      console.log(`ğŸ“ å·²åˆ‡æ¢å¯¹è¯ç›®æ ‡: ${defaultTarget}`);
      continue;
    }

    if (cmd === "to" || cmd === "å‘é€") {
      const id = String(parts[1] ?? "").trim();
      const text = parts.slice(2).join(" ").trim();
      if (!id || !text) {
        console.log("ç”¨æ³•: to <agentId> <æ¶ˆæ¯> æˆ– å‘é€ <agentId> <æ¶ˆæ¯>");
        continue;
      }
      system.sendTextToAgent(id, text, { taskId });
      continue;
    }

    // å‘é€é¡¾å®¢æ¶ˆæ¯åˆ°é»˜è®¤ç›®æ ‡
    system.sendTextToAgent(defaultTarget, input, { taskId });
  }
}

await main();
