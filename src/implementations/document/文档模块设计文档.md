# 文档模块设计文档

## 1. 模块概述

### 1.1 模块定位
文档模块是文件预览系统的核心模块之一，负责8种文档格式的纯前端预览实现。

### 1.2 支持的文件格式
- **pdf** - 便携式文档格式
- **ofd** - 版式文档格式（国产）
- **rtf** - 富文本格式
- **txt** - 纯文本格式
- **md** - Markdown格式
- **xml** - 可扩展标记语言
- **json** - JavaScript对象表示法
- **epub** - 电子书格式

### 1.3 开发优先级
**第一阶段（P0）**：PDF（本次实现）
**后续阶段（P1-P2）**：TXT, MD, JSON, XML, RTF, EPUB, OFD

## 2. 技术方案

### 2.1 PDF预览技术选型

#### 2.1.1 技术方案：PDF.js
- **开源库**：Mozilla PDF.js
- **技术优势**：
  - 纯JavaScript实现，符合项目约束
  - 功能完整，支持PDF渲染、缩放、翻页等
  - 性能优秀，支持大文件处理
  - 兼容性好，支持主流浏览器
  - 持续维护，社区活跃

#### 2.1.2 核心功能实现
1. **PDF文档加载**：使用ArrayBuffer读取文件内容
2. **页面渲染**：将PDF页面渲染为Canvas
3. **缩放控制**：支持缩放级别调整（25% - 400%）
4. **翻页控制**：支持上一页/下一页/跳转到指定页
5. **滚动预览**：支持滚动查看完整文档

### 2.2 技术架构设计

```
文档模块（document）
├── 核心接口层
│   ├── DocumentPreviewer.js      # 文档预览器基类
│   └── DocumentAdapter.js        # 文档适配器
├── PDF实现层（P0阶段）
│   ├── pdf/
│   │   ├── PDFPreviewer.js       # PDF预览器实现
│   │   ├── PDFRenderer.js        # PDF渲染引擎
│   │   └── PDFControls.js        # PDF控制组件
├── 工具层
│   ├── FileUtils.js              # 文件读取工具
│   └── PageUtils.js              # 页面处理工具
└── 配置层
    └── config.js                 # 模块配置
```

## 3. 模块接口设计

### 3.1 文档预览器基类（DocumentPreviewer）

```javascript
/**
 * 文档预览器基类
 */
class DocumentPreviewer {
  /**
   * 构造函数
   * @param {Object} options - 配置选项
   * @param {HTMLElement} options.container - 容器元素
   * @param {Object} options.fileInfo - 文件信息
   * @param {Function} options.onLoad - 加载完成回调
   * @param {Function} options.onError - 错误回调
   */
  constructor(options) {}

  /**
   * 加载文件
   * @param {ArrayBuffer|File} file - 文件数据
   */
  async load(file) {}

  /**
   * 渲染页面
   * @param {number} pageIndex - 页面索引（从0开始）
   */
  async renderPage(pageIndex) {}

  /**
   * 销毁实例
   */
  destroy() {}
}
```

### 3.2 PDF预览器实现（PDFPreviewer）

```javascript
/**
 * PDF预览器
 */
class PDFPreviewer extends DocumentPreviewer {
  /**
   * 加载PDF文件
   * @param {ArrayBuffer|File} file - 文件数据
   */
  async load(file) {}

  /**
   * 渲染PDF页面
   * @param {number} pageIndex - 页面索引
   */
  async renderPage(pageIndex) {}

  /**
   * 设置缩放级别
   * @param {number} scale - 缩放级别（0.25 - 4.0）
   */
  setScale(scale) {}

  /**
   * 获取总页数
   * @returns {number} 总页数
   */
  getTotalPages() {}

  /**
   * 跳转到指定页
   * @param {number} pageIndex - 页面索引
   */
  goToPage(pageIndex) {}

  /**
   * 上一页
   */
  previousPage() {}

  /**
   * 下一页
   */
  nextPage() {}
}
```

## 4. 代码结构规范

### 4.1 文件组织结构
```
src/implementations/document/
├── 文档模块设计文档.md          # 本文档
├── index.js                     # 模块入口
├── DocumentPreviewer.js         # 基类（代码量<200行）
├── pdf/
│   ├── index.js                # PDF模块入口（代码量<100行）
│   ├── PDFPreviewer.js         # PDF预览器（代码量<300行）
│   ├── PDFRenderer.js          # PDF渲染器（代码量<400行）
│   └── PDFControls.js          # PDF控制组件（代码量<200行）
└── utils/
    ├── FileUtils.js            # 文件工具（代码量<150行）
    └── PageUtils.js            # 页面工具（代码量<150行）
```

### 4.2 代码量控制
- 单个文件不超过500行
- 职责单一，功能内聚
- 良好的注释和文档

## 5. 依赖关系

### 5.1 外部依赖
- **pdfjs-dist** - PDF.js库（CDN引入）

### 5.2 内部依赖
- 核心框架层：FileTypeDetector, EventBus
- UI层：预览容器、控制栏组件

### 5.3 被依赖关系
- 核心框架层的预览器工厂会调用本模块

## 6. 性能优化

### 6.1 PDF预览优化策略
1. **按需渲染**：只渲染当前可见页面
2. **页面缓存**：缓存已渲染的页面，避免重复渲染
3. **懒加载**：滚动到可视区域时才加载页面
4. **Web Worker**：使用Web Worker进行PDF解析（可选）

### 6.2 大文件处理
1. **分块读取**：支持大文件的分块加载
2. **进度显示**：显示加载进度条
3. **内存管理**：及时释放不再使用的页面资源

## 7. 错误处理

### 7.1 错误类型
- **文件格式错误**：不是有效的PDF文件
- **文件损坏错误**：PDF文件损坏
- **加载超时错误**：文件加载超时
- **渲染错误**：页面渲染失败

### 7.2 错误处理机制
```javascript
try {
  await pdfPreviewer.load(file);
} catch (error) {
  if (error.type === 'invalid_format') {
    showError('不支持的文件格式');
  } else if (error.type === 'corrupted_file') {
    showError('文件已损坏');
  } else {
    showError('预览失败：' + error.message);
  }
}
```

## 8. UI集成规范

### 8.1 容器结构
```html
<div class="document-preview-container">
  <div class="pdf-canvas-wrapper">
    <!-- PDF渲染Canvas -->
    <canvas id="pdf-render-canvas"></canvas>
  </div>
  <div class="pdf-controls">
    <!-- 控制按钮 -->
    <button class="prev-page">上一页</button>
    <span class="page-info">第 <span id="current-page">1</span> / <span id="total-pages">10</span> 页</span>
    <button class="next-page">下一页</button>
    <div class="zoom-controls">
      <button class="zoom-out">-</button>
      <span class="zoom-level">100%</span>
      <button class="zoom-in">+</button>
    </div>
  </div>
</div>
```

### 8.2 样式规范
- 遵循UI设计文档的视觉风格
- 使用系统定义的色彩、字体、间距
- 响应式设计，支持移动端

## 9. 测试要求

### 9.1 单元测试
- 文件加载功能测试
- 页面渲染功能测试
- 缩放控制功能测试
- 翻页控制功能测试
- 错误处理测试

### 9.2 集成测试
- 与核心框架层的集成
- 与UI层的集成
- 完整预览流程测试

### 9.3 测试用例
- 正常PDF文件预览
- 大文件（10MB+）预览
- 多页PDF文档（50页+）
- 加密PDF文档（可选）
- 损坏的PDF文件
- 非PDF格式文件

## 10. 交付标准

### 10.1 代码交付
- [ ] 完整的PDF预览功能实现
- [ ] 单个文件代码量不超过500行
- [ ] 充分的代码注释
- [ ] 符合JavaScript代码规范
- [ ] 通过ESLint检查

### 10.2 功能交付
- [ ] 支持PDF文件预览
- [ ] 支持缩放控制（25%-400%）
- [ ] 支持翻页控制
- [ ] 支持滚动查看
- [ ] 错误提示友好
- [ ] 加载进度显示

### 10.3 测试交付
- [ ] 单元测试覆盖主要功能
- [ ] 通过集成测试
- [ ] 在主流浏览器测试通过

## 11. 扩展规划

### 11.1 P1阶段（后续）
- TXT预览（纯文本）
- MD预览（Markdown渲染）
- JSON预览（格式化显示）
- XML预览（高亮显示）

### 11.2 P2阶段（后续）
- RTF预览
- EPUB预览
- OFD预览（国产格式）

## 12. 参考资料

- [PDF.js官方文档](https://mozilla.github.io/pdf.js/)
- [PDF.js GitHub](https://github.com/mozilla/pdf.js)
- 项目需求文档
- UI设计文档
- 交互流程文档

---

**文档版本**: 1.0  
**编写日期**: 2024  
**设计者**: 文档模块负责人  
**审核者**: 待审核
