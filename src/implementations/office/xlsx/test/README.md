# xlsx子模块单元测试文档

## 测试概述

xlsx子模块单元测试包含三个测试套件：
1. **XlsxParser.test.js** - 测试xlsx解析器
2. **XlsxRenderer.test.js** - 测试xlsx渲染器
3. **index.test.js** - 测试xlsx模块主入口

## 测试文件结构

```
xlsx/test/
├── XlsxParser.test.js    # 解析器测试（7个测试用例）
├── XlsxRenderer.test.js  # 渲染器测试（13个测试用例）
├── index.test.js         # 模块测试（14个测试用例）
├── run-tests.js          # 测试运行器入口
└── README.md            # 本文档
```

**总测试用例数：34个**

## 运行测试

### 方式1：运行所有测试

```javascript
import { runAllTests } from './test/run-tests.js';

runAllTests().then(result => {
  console.log('测试完成');
});
```

### 方式2：运行单个测试套件

```javascript
import { runXlsxParserTests } from './test/XlsxParser.test.js';

runXlsxParserTests().then(result => {
  console.log('解析器测试完成');
});
```

### 方式3：在浏览器中运行

```html
<!DOCTYPE html>
<html>
<head>
  <title>xlsx单元测试</title>
</head>
<body>
  <script type="module">
    import { runAllTests } from './test/run-tests.js';
    runAllTests().then(result => {
      console.log('测试完成');
    });
  </script>
</body>
</html>
```

## 测试覆盖范围

### 1. XlsxParser.test.js (7个测试用例)

| 序号 | 测试名称 | 测试内容 |
|------|---------|---------|
| 1 | 解析器初始化 | 验证解析器实例创建和基本方法 |
| 2 | 提取工作表数据 | 验证工作表数据提取的正确性 |
| 3 | 提取合并单元格 | 验证合并单元格信息提取 |
| 4 | 提取单元格样式 | 验证字体、填充、对齐等样式提取 |
| 5 | 销毁解析器 | 验证资源清理功能 |
| 6 | 处理空工作表 | 验证对空单元格的处理 |
| 7 | 单元格类型识别 | 验证字符串、数字等类型的识别 |

### 2. XlsxRenderer.test.js (13个测试用例)

| 序号 | 测试名称 | 测试内容 |
|------|---------|---------|
| 1 | 渲染器初始化 | 验证渲染器实例创建和基本方法 |
| 2 | 初始化解析结果 | 验证解析结果的初始化 |
| 3 | 创建工作表标签 | 验证工作表标签的正确创建 |
| 4 | 创建表格容器 | 验证表格容器的创建 |
| 5 | 创建表格元素 | 验证HTML表格的正确生成 |
| 6 | 检查合并单元格 | 验证合并单元格的识别 |
| 7 | 应用单元格样式 | 验证样式应用到DOM元素 |
| 8 | 切换工作表 | 验证工作表切换功能 |
| 9 | 获取当前工作表索引 | 验证索引获取功能 |
| 10 | 获取工作表数量 | 验证数量获取功能 |
| 11 | 销毁渲染器 | 验证资源清理功能 |
| 12 | 处理超出范围索引 | 验证错误处理 |
| 13 | 处理负数索引 | 验证错误处理 |

### 3. index.test.js (14个测试用例)

| 序号 | 测试名称 | 测试内容 |
|------|---------|---------|
| 1 | 模块初始化 | 验证模块实例创建和基本方法 |
| 2 | 解析器实例存在 | 验证解析器实例的创建 |
| 3 | 渲染器实例存在 | 验证渲染器实例的创建 |
| 4 | 未加载时render异常 | 验证错误处理机制 |
| 5 | 未加载时switchSheet异常 | 验证错误处理机制 |
| 6 | 未加载时获取索引 | 验证默认返回值 |
| 7 | 未加载时获取数量 | 验证默认返回值 |
| 8 | 未加载时获取信息 | 验证默认返回值 |
| 9 | 销毁模块 | 验证资源清理功能 |
| 10 | 模拟加载成功 | 验证文件加载流程 |
| 11 | 模拟加载失败 | 验证错误处理 |
| 12 | 渲染到容器 | 验证渲染功能 |
| 13 | 切换工作表 | 验证工作表切换功能 |
| 14 | 获取文件信息 | 验证信息获取功能 |

## 测试输出示例

```
========================================
   xlsx子模块单元测试套件
========================================

【第1组】XlsxParser 测试
----------------------------------------

开始运行 XlsxParser 测试...

✅ 解析器应该正确初始化
✅ 应该正确提取工作表数据
✅ 应该正确提取合并单元格信息
✅ 应该正确提取单元格样式
✅ 应该正确销毁解析器资源
✅ 应该正确处理空工作表
✅ 应该正确识别单元格类型

测试完成: 7 通过, 0 失败

【第2组】XlsxRenderer 测试
----------------------------------------

开始运行 XlsxRenderer 测试...

✅ 渲染器应该正确初始化
✅ 应该正确初始化解析结果
✅ 应该正确创建工作表标签
✅ 应该正确创建表格容器
✅ 应该正确创建表格元素
✅ 应该正确检查合并单元格
✅ 应该正确应用单元格样式
✅ 应该正确切换工作表
✅ 应该正确获取当前工作表索引
✅ 应该正确获取工作表数量
✅ 应该正确销毁渲染器资源
✅ 应该正确处理超出范围的工作表索引
✅ 应该正确处理负数工作表索引

测试完成: 13 通过, 0 失败

【第3组】XlsxModule 测试
----------------------------------------

开始运行 XlsxModule 测试...

✅ 模块应该正确初始化
✅ 应该有解析器实例
✅ 应该有渲染器实例
✅ 未加载时调用render应该抛出异常
✅ 未加载时调用switchSheet应该抛出异常
✅ 未加载时获取当前工作表索引应该返回0
✅ 未加载时获取工作表数量应该返回0
✅ 未加载时获取文件信息应该返回null
✅ 应该正确销毁模块资源
✅ 应该能够模拟加载成功
✅ 应该能够处理加载失败
✅ 加载后应该能够渲染到容器
✅ 加载后应该能够切换工作表
✅ 加载后应该能够获取文件信息

测试完成: 14 通过, 0 失败

========================================
   测试结果汇总
========================================

总测试数: 34
✅ 通过: 34
❌ 失败: 0
通过率: 100.00%

详细结果:
----------------------------------------
XlsxParser: 7 通过, 0 失败
XlsxRenderer: 13 通过, 0 失败
XlsxModule: 14 通过, 0 失败
========================================

测试全部通过，退出码: 0
```

## 测试框架设计

本项目使用自定义的轻量级测试框架，包含以下断言方法：

- `assertEqual(actual, expected, message)` - 断言相等
- `assertTrue(value, message)` - 断言为真
- `assertFalse(value, message)` - 断言为假
- `assertNotNull(value, message)` - 断言非空
- `assertNull(value, message)` - 断言为空
- `assertThrows(fn, message)` - 断言抛出异常

## Mock对象说明

为了在不依赖真实DOM的情况下运行测试，测试中使用了Mock对象：

### MockContainer
模拟DOM容器，提供基础DOM操作接口。

### MockElement
模拟DOM元素，提供基础元素属性和方法。

### MockFile
模拟File对象，用于文件上传测试。

## 测试覆盖率

当前测试覆盖以下功能：

- ✅ 解析器核心功能
- ✅ 渲染器核心功能
- ✅ 模块API接口
- ✅ 错误处理机制
- ✅ 资源清理机制
- ✅ 边界情况处理

## 后续测试计划

1. **集成测试**
   - 与真实xlsx文件集成
   - 测试大文件性能
   - 测试边界情况

2. **性能测试**
   - 大文件解析性能
   - 渲染性能
   - 内存占用测试

3. **端到端测试**
   - 完整工作流测试
   - 跨浏览器测试

## 注意事项

1. 测试文件中的Mock对象仅用于单元测试，真实环境应该使用真实的DOM和File对象
2. 部分测试使用了模拟数据，需要在实际环境中进行集成测试
3. 测试覆盖率可以通过工具如Istanbul进行量化评估

## 维护建议

- 添加新功能时，同步添加对应的测试用例
- 修改现有功能时，确保相关测试仍然通过
- 定期运行测试套件，确保代码质量
- 对于发现的Bug，先编写失败的测试用例，再修复Bug

---

**文档版本**: 1.0  
**创建日期**: 2024  
**维护者**: xlsx子模块开发人员  
**最后更新**: 2024
