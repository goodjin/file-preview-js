需求文档— 自组织 AI Agent 社会

本文档对齐当前 demo 的实现现状：系统提供最小“能力原语 + 运行时”，组织规则由智能体自组织生成；同时系统在关键原语处做必要的硬约束，避免组织结构失控。

1. 背景
1.1 用户希望构建一个“由大模型智能体自我组织”的多智能体系统；系统仅提供最小能力原语与运行时，组织结构由智能体在运行时自主建立与演化。
1.2 术语说明：本文中出现的“公司/部门/老板”等仅为类比，便于理解，不是系统概念；系统概念只有组织（岗位与智能体实例的父子链结构）。类比中“部门”可理解为某智能体及其子岗位/子智能体集合，“公司”仅可理解为 Root 创建的第一级子智能体及其下属。
1.3 与类比社会形态的唯一差异：系统的总体目标（最高原则）是持续、稳定、可控地满足用户需求。

2. 总体目标（Mission）
2.1 最大化用户需求满足度与交付稳定性。
2.2 将复杂需求拆解为“可执行、可验证、可复用”的提示词与任务描述，并由自组织的岗位与智能体协作执行。
2.3 允许智能体在运行时自建子级智能体，实现自扩展与自适应。
2.4 核心设计目的：通过合理拆解需求，把任务分配给不同智能体协作完成；让每个智能体只控制很少的、必要的上下文，从而降低对大模型能力与超长上下文的依赖。
2.5 类比：像人类社会中个人只掌握局部知识，企业通过协作形成总体价值；本系统通过“岗位分工 + 工件协作 + 异步消息”实现同样的规模化协同。
2.6 交叉推进与绑定对象：智能体之间用异步消息通信；单个智能体不做“并行处理多个无关对象”，而是围绕其绑定的任务对象在相关事务间交叉推进（例如初诊→安排检查→读取报告→复诊推进）。为降低上下文混线风险，推荐采用“一任务对象绑定一个智能体实例”的方式：不同任务对象由不同智能体并行处理，从而提升总体吞吐并缩短任务完成时间。

3. 范围（Scope）
3.1 包含：组织建模（岗位 Role、智能体实例 Agent、父子链路）、异步消息通道（基础排队投递）、工件存储与引用、系统提示词/拼接模板加载、LLM 工具调用循环、基础日志。
3.2 不包含（后续规划）：完全自治的“无用户监督长期运行”（自我治理/自我监控/自我修复/自动终止或降级）、跨崩溃恢复与可重放、观测面板与评估体系。
3.3 包含（原则）：系统最小化——系统仅提供必要能力（工具库、基础提示词、异步消息与基础调度、工件存储与引用等），不提供任何预置组织架构（不内置岗位/智能体清单、也不内置“推荐组织”），组织必须由根智能体基于用户需求自发构建与演化。
3.4 不包含：对真实世界的法律责任主体替代；硬件/IoT 直接控制（除非单独扩展）。
3.5 边界划分（重要）：系统能力 vs 智能体自组织
3.5.1 系统能力（系统提供）：提供“能力”，不提供“组织社会规则”。包括：组织构建原语（创建/变更/裁撤）、异步消息通道与基础调度、工件存储与引用、系统预置提示词与拼接模板加载、基本可观测性。
3.5.2 自组织（智能体决定）：组织结构如何演化、岗位职责如何定义、升级/汇报/对齐如何运行、冲突如何裁决、质量标准与完成条件如何设定、何时创建/裁撤子级智能体等社会性规则，均由智能体通过运行时生成的提示词与消息协作来实现；系统不将这些规则写死为强制流程。

4. 用户与使用场景（共享）
4.1 用户类型
4.1.1 需求提出者：提出目标/约束/偏好。
4.1.2 管理者（可选）：配置系统参数。
4.2 典型场景
4.2.1 “建立并运转组织”：从根智能体（Root）开始，按需求建立岗位与智能体，让组织运转起来；并且随着需求变化，组织应合理、主动地扩大与收缩。
4.2.2 “多项目并行”：多个目标并行推进，组织资源动态调度。
4.2.3 “零人工自组织”：除起始需求输入外，组织构建与执行不依赖人工介入。
4.2.4 “长期无监督自治”（后续规划）：系统可持续运行，在异常时自动降级/恢复或终止。

5. 对系统的要求
5.1 定位与边界
5.1.1 系统只提供“能力”，不提供“组织社会规则”与固定流程。
5.1.2 系统不预置任何岗位/智能体清单与推荐组织结构。
5.1.3 上下文最小化原则：系统要支持把任务拆解到多个智能体，使单个智能体的工作上下文尽可能小且可控，避免把全部信息堆叠在单一智能体实例中。

5.2 系统职责（系统必须做的事）
5.2.1 提供组织构建原语：创建岗位、创建智能体实例；维护基础身份标识与父子链引用；持久化组织状态（org.json）。
5.2.2 提供异步消息通道：发送、投递、接收与基础排队；支持多个任务对象对应的多个智能体并行运转；单个智能体按消息到达顺序逐条处理其绑定任务对象的事务；更复杂的调度能力按需增强。
5.2.3 提供工件存储与引用：写入、读取与引用（artifact_ref）。
5.2.4 提供系统预置提示词与拼接模板加载：从 data/prompts（或等价目录）加载预置提示词与拼接模板。
5.2.5 装配运行提示词：把系统预置提示词、拼接模板与运行时信息装配为最终提示词；叠加智能体提交的岗位提示词与需求相关内容。
5.2.6 执行基础限制：对系统提供的关键能力做基础限制与拦截（可选）。
5.2.7 提供基本可观测性：通过日志与本地文件可追踪消息投递、组织状态与工件引用。
5.2.8 提供用户侧入口（对外接口）：用户可以提交自然语言需求给根智能体；用户的所有消息都先发送到“用户端点智能体”（id 固定为 "user"），由用户端点统一转发到目标智能体；组织对用户的所有回传也必须发送到该用户端点（to="user"）。用户端点智能体由代码驱动（非大模型），收到消息时输出到控制台与日志，并标注消息发送方。
5.2.9 当前版本不提供智能体选择器：用户侧交互暂时使用智能体 ID 指定通信目标。
5.2.10 提供命令行异步交互：用户在提交一个需求后，仍可继续在命令行输入后续内容；系统运转全异步，不阻碍用户操作。

5.3 系统能力（接口/原语）
5.3.1 面向智能体（LLM）的工具原语
5.3.1.1 find_role_by_name：按岗位名查找岗位。
5.3.1.2 create_role：创建岗位（提交岗位提示词 rolePrompt）。
5.3.1.3 spawn_agent：在指定岗位上创建智能体实例（Agent Instance）；parentAgentId 由系统根据调用者自动填充，智能体侧无需也不应传入。
5.3.1.4 send_message：异步消息发送（系统投递/排队）。
5.3.1.5 put_artifact / get_artifact：工件写入与读取（artifactRef 引用传递）。
5.3.1.6 console_print：输出到控制台（用于向用户展示）。
5.3.2 面向用户的对外入口
5.3.2.1 SubmitRequirement：提交自然语言需求给根智能体（系统生成 taskId）。
5.3.2.2 SendTextToAgent：用户通过“用户端点智能体”向指定智能体发送文本消息（入参：agentId + text，可选 taskId）。
5.3.2.3 OnUserMessage：注册回调，接收组织对用户的异步消息（消息目标为 to="user"）。
5.3.2.4 WaitForUserMessage：等待用户端点收到满足条件的消息（支持超时）。
5.3.3 规划项
5.3.3.1 智能体实例终止与回收（Terminate）。
5.3.3.2 工件列举/任务看板/指标与评估体系。

5.4 系统运行时模型（系统负责实现）
5.4.1 标识与关系：role_id / agent_instance_id / parent_agent_id；岗位包含 createdBy（创建该岗位的智能体 id）与 createdAt。
5.4.2 根智能体（Root）约束：Root 的 id 固定为 "root"，Root 随系统启动创建，不持久化进 org.json。
5.4.3 上下文与隔离：每个实例拥有独立运行上下文；系统按 agent_instance_id 隔离。
5.4.4 工件优先：系统应支持用工件引用（artifactRef）作为跨岗位交付与状态传递的主要载体，减少长文本在消息中重复流转。

5.5 系统硬约束（防失控）
5.5.1 spawn_agent 的 parentAgentId 由系统按调用者智能体 id 自动填充；若请求中显式传入 parentAgentId，必须与调用者智能体 id 一致，否则返回失败。
5.5.2 所有智能体（含 Root）：只能在“自己创建的子岗位”上 spawn_agent；其它情况一律返回失败。
5.5.3 Root 智能体：对每个 taskId 只能创建 1 个直属子智能体实例（parentAgentId 为 root），重复调用必须复用。

5.6 系统非功能需求（最小 + 可选增强）
5.6.1 最小：异步消息可用；工件可存取；提示词可从目录加载。
5.6.2 可选增强：重试/背压/死信队列、跨崩溃恢复、强审计与可重放、更细粒度观测面板等。

6. 对智能体的要求
6.1 智能体定位
6.1.1 智能体负责“组织社会规则”的生成与执行：组织结构、岗位职责、汇报/升级/对齐、冲突裁决、质量标准等。
6.1.2 社会性规则主要通过运行时生成的岗位提示词、任务消息与工件协作来体现，系统不将其写死为强制流程。
6.1.3 上下文纪律：智能体应只保留完成当前职责所必需的最小上下文；跨岗位/跨阶段信息应优先写入工件并用引用传递，而不是在对话中无限堆叠。
6.1.4 绑定对象：智能体默认只服务一个任务对象（例如一个医生只对一个患者负责），不在同一智能体内交叉处理多个无关任务对象，避免混线与遗漏。

6.2 根智能体（Root Agent）
6.2.1 职责：接收用户需求，为每个 taskId 创建且仅创建 1 个直属子智能体实例（需求负责人/任务入口）。
6.2.2 边界：根智能体不承担具体业务岗位工作；不负责用户消息转发；后续执行与用户交互由其创建的子智能体及更下级组织完成。

6.3 组织构建与演化（由智能体决定，系统提供原语）
6.3.1 建立：根据需求创建子岗位，并在子岗位上创建子智能体。
6.3.2 发展（后续规划）：随着任务量变化新增岗位、引入专精岗位；子级智能体的新增与裁撤由智能体侧策略决定。
6.3.3 进化（后续规划）：需求变化时合并/拆分岗位职责、裁撤低价值岗位，并更新指挥链与边界描述。
6.3.4 同岗同质性：同一岗位下的实例从相同的系统预置提示词起点与同一岗位提示词起点开始；差异来自任务与通信内容不同。

6.4 岗位模板与岗位提示词（运行时内容，智能体负责）
6.4.1 岗位模板应包含：岗位目标、输入规范、输出规范、可用工具、升级/汇报路径、度量方式等。
6.4.2 岗位提示词：由智能体在运行时生成并随 CreateRole 提交；用于约束岗位职责与工作流程；不属于系统提示词目录的管理范围。
6.4.3 汇报策略：由父级在创建岗位时通过岗位提示词设定“何时汇报、汇报给谁、汇报什么、频率如何”；系统不强制。

6.5 协作与通信（智能体规则，系统提供通道）
6.5.1 智能体之间通过异步消息协作；消息内容结构与规范由岗位提示词或组织策略定义。
6.5.2 交叉沟通：同一智能体可以与多个智能体交替沟通，但应围绕其绑定任务对象推进；不在同一智能体内交叉处理多个无关任务对象。智能体应使用 taskId/阶段标识管理“同一任务对象内”的多轮推进，避免遗漏。
6.5.3 任务分解：可自顶向下拆解，也可自底向上升级；升级触发条件与升级路径由组织策略定义。
6.5.4 工件协作：跨岗位交付以工件引用为主，避免长上下文直接传递。

6.6 生命周期（社会流程，智能体负责；Terminate 为后续规划）
6.6.1 Plan：形成执行计划与子任务。
6.6.2 Act：调用工具、生成工件、与其他岗位通信。
6.6.3 Report：按岗位提示词定义汇报/异常上报/阶段同步（可选）。
6.6.4 HandOff：向上级/同级移交工件或状态（可选）。
6.6.5 Learn：沉淀知识与复盘（可选，由组织策略决定）。
6.6.6 Terminate（后续规划）：何时终止由组织策略决定；系统负责资源释放与必要信息保留。
6.6.7 销毁交接（重要）：外部交互结束或任务对象终止时，若需要销毁绑定智能体，应先完成交接——将关键状态与产出写入工件并回传给上级/业务接入方；确保后续接手方能继续推进或完成收尾，再执行销毁。

7. 验收标准
7.1 系统验收
7.1.1 系统启动时仅存在根智能体；Root 的 id 固定为 "root"，且不写入 org.json。
7.1.2 组织构建原语可用：能创建岗位并创建绑定岗位的智能体实例；岗位名重复时应复用已有岗位（避免重复创建）。
7.1.3 异步消息通道可用：能发送与接收消息并完成基础排队投递。
7.1.4 工件存取可用：能写入与读取工件并用引用传递。
7.1.5 系统硬约束生效（防失控）：见 5.5。
7.1.6 系统预置提示词可用：能从 data/prompts 加载预置提示词与拼接模板。

7.2 自组织验收
7.2.1 组织能自发建立与扩展：由根智能体创建第一个岗位与智能体实例，完成“接收需求→执行→工件交付→回传”的闭环。
7.2.2 岗位可自定义：上级通过岗位提示词定义下级职责、输入输出与完成标准。
7.2.3 子岗位约束可用：下级若需要分工，只能创建子岗位，并在子岗位上创建子智能体。

8. 里程碑（建议）
8.1 M1：系统原语可用（组织构建、消息通道、工件存储、提示词加载）
8.2 M2：自组织跑通（根智能体递归构建组织并完成任务闭环）
8.3 M3：可选增强（调度增强、观测增强、可靠性增强）

9. 关键术语（附录，共享）
9.1 组织（Organization）：岗位与智能体实例构成的层级结构；以岗位与父子链为主。
9.2 岗位（Role Template）：岗位职责、能力边界、输入输出标准、升级/汇报路径的模板定义。
9.3 智能体实例（Agent Instance）：某岗位模板在某任务场景中的一次运行实体。
9.4 工件（Artifact）：任务中产生的可持久化产物（文档、代码、数据文件、决策记录等）。
9.5 系统预置提示词：系统提供并统一存放在 data/prompts 的提示词与拼接模板。
9.6 岗位提示词：智能体运行时生成并随 CreateRole 提交的提示词。
9.7 异步消息：智能体之间的协作载体，以异步方式发送与投递。
9.8 组织构建原语：系统提供的创建/变更/裁撤岗位、智能体实例等能力集合。
9.9 子岗位（Child Role）：createdBy 等于某智能体 id 的岗位；该智能体只能在其子岗位上创建子智能体。

10. 待审阅的关键决策点（偏智能体侧）
10.1 “组织演化策略”：何时建立/合并/裁撤岗位，何时雇佣/解雇员工智能体。
10.2 “无人参与风险处置”：哪些风险等级选择继续/降级/阻断/终止。
10.3 “记忆策略”：是否允许跨任务复用知识；允许到什么粒度；默认脱敏规则。
10.4 “成功度量”：更看重满意度、交付速度，还是稳定性？优先级如何排序。
10.5 “无监督运行的通知边界”：哪些事件允许异步通知用户，哪些仅内部处理并留痕。
10.6 “扩容与分工触发条件”：以队列长度还是失败率为主触发创建子级智能体。
