# 对话记录中工件点击修复 - 需求文档

## 1. 问题描述

### 1.1 当前问题
在对话记录中显示的工件链接无法正确打开。点击工件链接时，工件管理器无法正确加载工件内容。

### 1.2 问题根源分析

#### 问题1: 工件ID被错误拼接
在 `_createArtifactFromRef` 方法中（chat-panel.mjs 第1329行）：
```javascript
return {
  id: `${message.id}_artifact_${artifactId}`,  // 错误：拼接了消息ID
  type: artifactType,
  name: artifactName,
  content: artifactId,
  source: message,
  artifactRef: artifactRef
};
```

实际工件ID应该是 `0f274359-c2ea-4d6b-bacb-a9c6d6a7b53c`，但被拼接成了 `tool-call_-7958838520463267311_artifact_0f274359-c2ea-4d6b-bacb-a9c6d6a7b53c`。

工件管理器使用这个错误的ID调用API：
- `/artifacts/${artifact.id}` - 返回404，因为ID不存在
- `/artifacts/${artifact.id}/metadata` - 返回404

#### 问题2: 传递了不必要的参数
工件管理器的 `openArtifact` 方法只需要工件ID，它会自己通过API获取所有信息：
- 工件内容（通过 `/artifacts/${id}`）
- 工件元数据（通过 `/artifacts/${id}/metadata`，包含type、filename、name等）

但当前代码传递了 `type`、`name`、`content` 等参数，这些参数：
1. 可能不准确（从工具调用参数推断的）
2. 不应该由调用方提供，应该由工件管理器从后端获取
3. 增加了不必要的复杂度

### 1.3 设计原则
**统一的工件打开方式**：无论在哪里（对话记录、工件列表、工作空间），只要提供正确的工件ID，就能正确打开工件，不需要提供任何其他信息。工件管理器负责根据ID获取所有必要的元数据。

### 1.3 对比工件管理器中的正常工作流程
在工件管理器的列表中点击工件时：
1. 从后端API `/artifacts` 获取工件列表，每个工件包含真实的ID
2. 点击工件时，传递包含真实ID的工件对象
3. `openArtifact` 方法使用真实ID调用API获取内容和元数据
4. 成功加载并显示工件

## 2. 用户故事

### 2.1 作为用户
**我想要**在对话记录中点击工件链接时能够正确打开工件  
**以便**查看智能体创建的工件内容

**验收标准：**
- 点击图片工件链接时，能够在图片查看器中正确显示
- 点击非图片工件链接（JSON、文本、代码等）时，能够在工件管理器中正确打开
- 工件管理器能够正确加载工件内容并显示
- 错误处理机制正常工作，显示友好的错误提示

## 3. 功能需求

### 3.1 修复工件ID拼接问题
**需求ID:** 3.1  
**描述:** 在 `_createArtifactFromRef` 方法中，直接使用真实的工件ID，不要拼接

**详细说明:**
- 当前代码：`id: \`${message.id}_artifact_${artifactId}\``
- 修改为：`id: artifactId`
- 移除所有不必要的字段（type、name、content等）

### 3.2 简化工件对象结构
**需求ID:** 3.2  
**描述:** 传递给工件管理器的工件对象只需要包含ID

**详细说明:**
- 工件对象只需要：`{ id: artifactId }`
- 所有其他信息（type、filename、name、content等）由工件管理器通过API获取
- 这是统一的工件打开方式，适用于所有场景

### 3.3 更新工件链接HTML
**需求ID:** 3.3  
**描述:** 工件链接的 `data-artifact-id` 属性应该存储真实的工件ID

**详细说明:**
- 在 `_renderTypeGroup` 方法中，确保 `data-artifact-id` 存储的是真实的工件ID
- 移除不必要的 `data-artifact-type`、`data-artifact-content` 等属性
- 只保留 `data-artifact-id`

### 3.4 简化工件点击处理
**需求ID:** 3.4  
**描述:** 在 `_initArtifactInteractionHandler` 中，只读取工件ID

**详细说明:**
- 从 `dataset` 中只读取 `artifactId`
- 构建工件对象：`{ id: artifactId }`
- 传递给工件管理器

### 3.5 移除向后兼容代码
**需求ID:** 3.5  
**描述:** 移除 `_createArtifactFromImage` 等向后兼容的代码路径

**详细说明:**
- 不再支持旧格式的图片数组（`payload.images`、`payload.result.images`）
- 只支持新格式的 `artifactRef`
- 简化代码逻辑

## 4. 非功能需求

### 4.1 性能
- 修复不应影响页面渲染性能
- 减少不必要的数据传递，提高效率

### 4.2 简洁性
- 代码逻辑更简洁，只传递必要的ID
- 移除推断type、name等的复杂逻辑
- 统一的工件打开方式

### 4.3 可维护性
- 代码修改应该简洁明了
- 添加必要的注释说明修复内容
- 保持代码风格一致

## 5. 约束条件

### 5.1 技术约束
- 只修改 `web/js/components/chat-panel.mjs` 文件
- 不修改工件管理器的代码
- 不修改后端API
- 不考虑向后兼容旧格式

### 5.2 业务约束
- 不改变用户界面的外观
- 保持错误处理机制不变
- 只支持新格式的 `artifactRef`

## 6. 验收标准

### 6.1 功能验收
- [ ] 点击对话记录中的图片工件链接，能够在图片查看器中正确显示
- [ ] 点击对话记录中的JSON工件链接，能够在工件管理器中正确打开并显示内容
- [ ] 点击对话记录中的文本工件链接，能够在工件管理器中正确打开并显示内容
- [ ] 点击对话记录中的代码工件链接，能够在工件管理器中正确打开并显示内容
- [ ] 点击对话记录中的HTML/CSS工件链接，能够在工件管理器中正确打开并显示内容
- [ ] 工件管理器能够通过API正确加载工件内容（使用真实的工件ID）
- [ ] 工件管理器能够通过API正确加载工件元数据（使用真实的工件ID）

### 6.2 API调用验证
- [ ] 验证API调用使用的是真实的工件ID（如 `0f274359-c2ea-4d6b-bacb-a9c6d6a7b53c`）
- [ ] 验证API调用不使用拼接的ID（如 `tool-call_xxx_artifact_xxx`）
- [ ] 验证 `/artifacts/${id}` 返回200状态码
- [ ] 验证 `/artifacts/${id}/metadata` 返回200状态码

### 6.3 代码简洁性验证
- [ ] 工件对象只包含 `id` 字段
- [ ] 移除了所有推断type、name的逻辑
- [ ] 移除了向后兼容的代码路径
- [ ] 代码逻辑更简洁清晰

## 7. 优先级

**高优先级** - 这是一个影响用户体验的关键bug，需要尽快修复。

## 8. 依赖关系

### 8.1 依赖的模块
- `web/js/components/chat-panel.mjs` - 需要修改的主要文件
- `web/js/components/artifact-manager.mjs` - 依赖的工件管理器（不修改）

### 8.2 被依赖的功能
- 工件管理器 (`ArtifactManager`)
- Toast提示系统

### 8.3 API依赖
- `GET /artifacts/${id}` - 获取工件内容
- `GET /artifacts/${id}/metadata` - 获取工件元数据

## 9. 风险评估

### 9.1 技术风险
- **低风险**: 修改范围小，只涉及工件ID的使用
- **低风险**: 不影响其他功能模块
- **注意**: 移除向后兼容代码，旧格式的工件将无法显示（可接受）

### 9.2 业务风险
- **低风险**: 修复bug，提供统一的工件打开方式
- **注意**: 不支持旧格式，但新系统不应该产生旧格式的数据

## 10. 测试计划

### 10.1 单元测试
- 测试工件ID提取逻辑（从 `artifactRef` 中提取）
- 测试工件对象构建逻辑（只包含ID）

### 10.2 集成测试
- 测试点击工件链接后的完整流程
- 测试工件管理器能否正确加载工件
- 测试API调用使用正确的ID

### 10.3 手动测试
- 在浏览器中测试各种类型的工件链接
- 验证工件管理器能够正确打开工件
- 验证工件内容和元数据正确显示
- 测试错误处理流程
