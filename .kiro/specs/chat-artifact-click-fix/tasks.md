# 对话记录中工件点击修复 - 任务列表

## 任务概述
修复对话记录中工件链接点击无法正确打开的问题，实现统一的工件打开方式：只需要工件ID。

## 任务列表

### 1. 修改 _createArtifactFromRef 方法 ✅
- [x] 1.1 移除ID拼接逻辑，直接使用真实的工件ID
- [x] 1.2 移除type、name、content等不必要的字段
- [x] 1.3 移除推断type和name的逻辑调用
- [x] 1.4 简化返回值为只包含ID的对象：`{ id: artifactId }`
- [x] 1.5 更新方法注释，说明只返回ID

### 2. 修改工件链接渲染（renderToolCallGroupArtifacts）✅
- [x] 2.1 移除 `data-artifact-type` 属性
- [x] 2.2 移除 `data-artifact-content` 属性
- [x] 2.3 只保留 `data-artifact-id` 属性，存储真实的工件ID
- [x] 2.4 修改显示内容为完整的工件ID（不截断，不显示名称）
- [x] 2.5 修改URL为直接使用ID
- [x] 2.6 修改title为完整的工件ID

### 3. 修改 _initArtifactInteractionHandler 方法 ✅
- [x] 3.1 只读取 `artifactId` 从 dataset
- [x] 3.2 移除读取type、content、name的逻辑
- [x] 3.3 添加ID验证逻辑
- [x] 3.4 简化工件对象构建为只包含ID：`{ id: artifactId }`

### 4. 修改 _handleArtifactClick 方法 ✅
- [x] 4.1 移除类型判断和处理器分发逻辑
- [x] 4.2 统一使用工件管理器打开，调用 `_openArtifactWithManager`
- [x] 4.3 简化错误日志，移除type相关信息
- [x] 4.4 更新方法注释，说明统一使用工件管理器

### 5. 修改 _openArtifactWithManager 方法 ✅
- [x] 5.1 移除构建 `managerArtifact` 的逻辑
- [x] 5.2 直接传递 `{ id: artifact.id }` 给工件管理器
- [x] 5.3 更新方法注释，说明只传递ID

### 6. 简化 _collectAllArtifacts 方法 ✅
- [x] 6.1 移除向后兼容的代码路径（images数组处理）
- [x] 6.2 只保留 `payload.result.artifactRef` 格式的处理
- [x] 6.3 更新方法注释，说明只支持新格式

### 7. 简化 renderToolCallGroupArtifacts 方法 ✅
- [x] 7.1 移除按类型分组的逻辑
- [x] 7.2 统一显示为链接列表
- [x] 7.3 只显示完整的工件ID，不显示名称或其他内容
- [x] 7.4 更新方法注释，说明只显示ID的统一方式

### 8. 清理不必要的代码
- [x] 8.1 删除 renderMessageImages 方法及其所有调用
- [x] 8.2 修改 browser_javascript_executor.js 返回 artifactRef 格式
- [ ] 8.3 检查并删除未使用的导入（如果有MIME类型相关的导入不再使用）
- [ ] 8.4 检查是否有其他遗留的类型处理器相关代码
- [ ] 8.5 验证所有工件相关方法都已更新为统一方式

### 9. 测试验证
- [ ] 9.1 测试点击图片工件链接，验证能正确打开
- [ ] 9.2 测试点击JSON工件链接，验证能正确打开
- [ ] 9.3 测试点击文本工件链接，验证能正确打开
- [ ] 9.4 测试点击代码工件链接，验证能正确打开
- [ ] 9.5 测试点击HTML/CSS工件链接，验证能正确打开
- [ ] 9.6 验证API调用使用正确的工件ID（通过浏览器开发者工具）
- [ ] 9.7 验证工件管理器能正确加载工件内容和元数据
- [ ] 9.8 验证错误处理机制正常工作

## 任务状态总结

**已完成的任务：**
- ✅ 任务1：_createArtifactFromRef 方法已完全按设计修改
- ✅ 任务2：工件链接渲染已统一为只显示ID
- ✅ 任务3：_initArtifactInteractionHandler 已简化为只读取ID
- ✅ 任务4：_handleArtifactClick 已统一使用工件管理器
- ✅ 任务5：_openArtifactWithManager 已简化为只传递ID
- ✅ 任务6：_collectAllArtifacts 已移除向后兼容代码
- ✅ 任务7：renderToolCallGroupArtifacts 已统一显示方式

**待完成的任务：**
- ⏳ 任务8：清理不必要的代码（检查导入和遗留代码）
- ⏳ 任务9：全面测试验证

## 核心修改已完成

根据代码检查，所有核心功能已按照设计文档完成修改：

1. **工件对象结构**：已简化为只包含 `{ id: artifactId }`
2. **工件链接HTML**：只保留 `data-artifact-id` 属性，显示完整ID
3. **点击处理**：统一使用工件管理器，不再根据类型分发
4. **API调用**：传递真实的工件ID，不再拼接
5. **向后兼容代码**：已全部移除

## 下一步行动

1. **代码清理**（任务8）：
   - 检查文件顶部的导入语句，确认MIME类型相关导入是否还需要
   - 搜索是否有其他遗留的类型处理器代码
   
2. **测试验证**（任务9）：
   - 在浏览器中测试各种类型的工件链接
   - 使用开发者工具验证API调用
   - 确认工件管理器能正确加载内容

## 注意事项

1. **不考虑向后兼容**：已移除所有旧格式的支持代码
2. **统一的工件打开方式**：已实现只传递ID的统一方式
3. **代码简洁性**：核心逻辑已大幅简化
4. **测试覆盖**：需要进行全面测试以确保所有类型的工件都能正确打开

## 预期结果

- 工件链接点击后能正确打开 ✅（代码已实现）
- API调用使用真实的工件ID ✅（代码已实现）
- 代码更简洁，统一的工件打开方式 ✅（代码已实现）
- 需要测试验证功能正常工作 ⏳（待测试）
