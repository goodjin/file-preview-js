# 需求文档

## 简介

本功能为智能体社会系统提供一个仿微信风格的 Web 界面，用于查看所有智能体（包括 root、user 和其他智能体）之间的对话。界面支持智能体列表浏览、岗位检索、组织结构总览，以及类似微信群聊的对话展示。用户可以通过该界面以 user 身份向智能体发送消息。

## 术语表

- **智能体查看器**: Web 界面主应用，负责展示智能体列表和对话内容
- **智能体列表面板**: 左侧智能体列表面板，显示所有智能体并支持检索
- **对话面板**: 右侧对话面板，展示类似微信群聊的消息界面
- **总览面板**: 总览面板，展示岗位关系树状图和智能体统计
- **消息详情弹窗**: 消息详情弹窗，显示消息的技术数据
- **HTTP服务器**: 现有的 HTTP 服务器组件，提供 REST API 接口
- **消息总线**: 消息总线组件，负责智能体间消息传递
- **组织原语**: 组织原语组件，管理岗位和智能体元数据

## 需求列表

### 需求 1: 智能体列表展示

**用户故事:** 作为开发者，我希望查看系统中所有智能体的列表，以便选择某个智能体查看其对话记录。

#### 验收标准

1. 当智能体查看器加载时，智能体列表面板应显示所有智能体，包括 root、user 和动态创建的智能体
2. 智能体列表面板应显示每个智能体的 ID、岗位名称和创建时间
3. 当显示智能体列表时，智能体列表面板应默认按创建时间升序排列（最老的在前）
4. 智能体列表面板应提供排序按钮，允许用户选择不同的排序方式（按创建时间升序/降序）
5. 智能体列表面板应使用不同的图标或颜色来区分 root 智能体、user 智能体和其他智能体
6. 当智能体被终止时，智能体列表面板应显示视觉指示器表明其已终止状态

### 需求 2: 岗位检索功能

**用户故事:** 作为开发者，我希望按岗位筛选智能体，以便快速找到特定类型的智能体。

#### 验收标准

1. 智能体列表面板应提供一个搜索/筛选输入框用于按岗位筛选
2. 当用户在筛选框中输入岗位名称时，智能体列表面板应只显示匹配该岗位的智能体
3. 当清空筛选条件时，智能体列表面板应显示所有智能体
4. 智能体列表面板应支持岗位名称的部分匹配（不区分大小写）

### 需求 3: 组织结构总览

**用户故事:** 作为开发者，我希望查看组织结构的总览，以便了解智能体的层级关系和分布情况。

#### 验收标准

1. 总览面板应显示树状图，展示智能体之间的父子关系
2. 总览面板应按岗位分组智能体，并显示每个岗位的智能体数量
3. 当点击树状图中的智能体节点时，智能体查看器应跳转到该智能体的对话视图
4. 当新智能体被创建或终止时，总览面板应实时更新

### 需求 4: 对话界面展示

**用户故事:** 作为开发者，我希望在类似微信的聊天界面中查看对话，以便轻松跟踪消息流。

#### 验收标准

1. 当选中某个智能体时，对话面板应显示该智能体发送和接收的所有消息
2. 对话面板应将当前智能体发送的消息显示在右侧，使用绿色背景和黑色文字
3. 对话面板应将当前智能体接收的消息显示在左侧，使用白色背景和黑色文字
4. 当显示消息时，对话面板应显示发送者 ID 和时间戳
5. 对话面板应将消息来源（发送者 ID）显示为可点击的链接
6. 当点击消息来源链接时，智能体查看器应跳转到发送者的聊天界面，并自动滚动到该消息发送的位置
7. 当有新消息到达时，对话面板应自动滚动到最新消息
8. 对话面板应按时间顺序显示消息

### 需求 5: 消息详情查看

**用户故事:** 作为开发者，我希望查看消息的详细技术数据，以便调试和理解消息结构。

#### 验收标准

1. 对话面板应在每条消息上显示一个小按钮用于查看详情
2. 当点击详情按钮时，消息详情弹窗应打开并显示完整的消息数据
3. 消息详情弹窗应显示消息 ID、taskId、payload、createdAt 以及其他元数据
4. 消息详情弹窗应以可读的、语法高亮的格式显示 JSON payload
5. 当点击弹窗外部或按 Escape 键时，消息详情弹窗应关闭

### 需求 6: 用户消息发送

**用户故事:** 作为开发者，我希望以 user 身份向智能体发送消息，以便通过 Web 界面与智能体系统交互。

#### 验收标准

1. 对话面板应提供一个文本输入框用于编写消息
2. 当用户提交消息时，智能体查看器应通过 HTTP API 以 user 智能体身份将消息发送给选中的智能体
3. 当消息发送成功时，对话面板应在对话中显示已发送的消息
4. 如果消息发送失败，对话面板应向用户显示错误通知
5. 消息成功提交后，对话面板应清空输入框

### 需求 7: 实时消息更新

**用户故事:** 作为开发者，我希望实时看到新消息，以便在消息发生时监控智能体对话。

#### 验收标准

1. 智能体查看器应定期轮询获取新消息（可配置，默认 2 秒）
2. 当收到新消息时，对话面板应将其追加到对话中，无需刷新整个页面
3. 当新智能体被创建时，智能体列表面板应更新以包含它们
4. 当非选中智能体有新消息到达时，智能体查看器应提供视觉指示

### 需求 8: Web 服务集成

**用户故事:** 作为开发者，我希望 Web 界面由现有的 HTTP 服务器提供服务，以便无需额外设置即可访问。

#### 验收标准

1. 当请求匹配 Web 资源路径时，HTTP服务器应从 web 文件夹提供静态文件
2. HTTP服务器应提供 API 端点用于获取智能体列表、消息和组织结构
3. HTTP服务器应提供 API 端点用于从 user 发送消息
4. 当 web 文件夹不存在时，HTTP服务器应继续正常运行现有的 API 端点
5. HTTP服务器应从 OrgPrimitives 读取持久化的智能体和岗位数据，确保服务器重启后数据不丢失

### 需求 9: 消息数据 API

**用户故事:** 作为开发者，我希望有完整的消息数据 API 端点，以便 Web 界面可以获取所有必要的信息。

#### 验收标准

1. HTTP服务器应提供 GET /api/agents 端点，返回所有智能体及其元数据
2. HTTP服务器应提供 GET /api/roles 端点，返回所有岗位及智能体数量
3. HTTP服务器应提供 GET /api/messages/:agentId 端点，返回特定智能体的所有消息
4. HTTP服务器应提供 GET /api/org/tree 端点，返回组织层级结构
5. HTTP服务器应提供 POST /api/send 端点，用于向智能体发送消息
6. 当从日志文件解析消息时，HTTP服务器应提取完整的消息数据，包括 payload

### 需求 10: 消息持久化

**用户故事:** 作为开发者，我希望服务器重启后仍能看到之前的所有消息，以便不丢失历史对话记录。

#### 验收标准

1. 当收到新消息时，HTTP服务器应将消息追加到发送者和接收者各自的消息日志文件
2. 消息日志文件应按智能体 ID 分割，格式为 `{agentId}.jsonl`（每行一条 JSON 消息）
3. 当服务器启动时，HTTP服务器应从消息日志文件加载历史消息
4. 如果消息日志文件不存在或某行损坏，HTTP服务器应跳过损坏的行并继续加载
5. 持久化的消息数据应包含完整的消息结构（id、from、to、taskId、payload、createdAt）
6. 消息追加应使用追加写入模式，避免重写整个文件
7. 查询某个智能体的消息时，只需读取该智能体的日志文件
