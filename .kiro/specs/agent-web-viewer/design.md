# 设计文档

## 概述

智能体 Web 查看器是一个仿微信风格的单页应用（SPA），用于可视化展示智能体社会系统中的对话和组织结构。该应用使用纯 HTML/CSS/JavaScript 实现，无需构建工具，由现有的 HTTP 服务器提供静态文件服务。

## 架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        Web 浏览器                                │
│  ┌──────────────┐  ┌──────────────────────────────────────────┐ │
│  │ 智能体列表面板 │  │              对话面板                     │ │
│  │              │  │  ┌────────────────────────────────────┐  │ │
│  │ ┌──────────┐ │  │  │           消息列表                  │  │ │
│  │ │ 搜索框   │ │  │  │  ┌─────────────────────────────┐  │  │ │
│  │ └──────────┘ │  │  │  │ 消息气泡 (左/右对齐)        │  │  │ │
│  │ ┌──────────┐ │  │  │  │ - 发送者链接               │  │  │ │
│  │ │ 排序按钮 │ │  │  │  │ - 时间戳                   │  │  │ │
│  │ └──────────┘ │  │  │  │ - 详情按钮                 │  │  │ │
│  │ ┌──────────┐ │  │  │  └─────────────────────────────┘  │  │ │
│  │ │ 智能体   │ │  │  └────────────────────────────────────┘  │ │
│  │ │ 列表项   │ │  │  ┌────────────────────────────────────┐  │ │
│  │ │ ...      │ │  │  │           输入框                    │  │ │
│  │ └──────────┘ │  │  └────────────────────────────────────┘  │ │
│  └──────────────┘  └──────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ HTTP API
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      HTTP 服务器                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │ 静态文件    │  │ API 路由    │  │ 消息存储                │  │
│  │ 服务        │  │             │  │ (内存 + 日志解析)       │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 组件和接口

### 前端组件

#### 1. App（主应用）
- 职责：管理全局状态、路由、定时轮询
- 状态：当前选中的智能体、视图模式（列表/总览）
- 方法：
  - `init()`: 初始化应用
  - `selectAgent(agentId)`: 选择智能体
  - `scrollToMessage(agentId, messageId)`: 跳转到指定消息

#### 2. AgentListPanel（智能体列表面板）
- 职责：显示智能体列表、搜索筛选、排序
- 状态：智能体列表、筛选条件、排序方式
- 方法：
  - `render()`: 渲染列表
  - `filter(keyword)`: 按岗位筛选
  - `sort(order)`: 切换排序方式
  - `highlightNewMessage(agentId)`: 高亮有新消息的智能体

#### 3. ChatPanel（对话面板）
- 职责：显示对话消息、发送消息
- 状态：当前智能体的消息列表
- 方法：
  - `render()`: 渲染消息列表
  - `appendMessage(message)`: 追加新消息
  - `sendMessage(text)`: 发送消息
  - `scrollToBottom()`: 滚动到底部
  - `scrollToMessage(messageId)`: 滚动到指定消息

#### 4. OverviewPanel（总览面板）
- 职责：显示组织结构树状图和统计
- 状态：组织树数据、岗位统计
- 方法：
  - `render()`: 渲染树状图
  - `onNodeClick(agentId)`: 节点点击处理

#### 5. MessageDetailModal（消息详情弹窗）
- 职责：显示消息的完整技术数据
- 状态：当前显示的消息
- 方法：
  - `show(message)`: 显示弹窗
  - `hide()`: 隐藏弹窗

### 后端 API 扩展

在现有 HTTPServer 类中添加以下端点：

| 端点 | 方法 | 描述 |
|------|------|------|
| `/api/agents` | GET | 获取所有智能体列表（从 OrgPrimitives 读取持久化数据） |
| `/api/roles` | GET | 获取所有岗位列表（从 OrgPrimitives 读取持久化数据） |
| `/api/messages/:agentId` | GET | 获取指定智能体的所有消息（从 .jsonl 文件读取） |
| `/api/org/tree` | GET | 获取组织层级树结构（从 OrgPrimitives 构建） |
| `/api/send` | POST | 发送消息（已存在，需确认） |
| `/web/*` | GET | 静态文件服务 |

### 数据来源说明

- **智能体和岗位数据**: 从 `OrgPrimitives` 读取，该组件已实现持久化到 `{runtimeDir}/org.json`
- **消息数据**: 从 `{runtimeDir}/web/messages/{agentId}.jsonl` 读取
- **服务器重启后**: 智能体和岗位从 `org.json` 恢复，消息从 `.jsonl` 文件恢复

### 消息存储

扩展 HTTPServer 以存储所有消息（不仅仅是发给 user 的），并支持持久化：

```javascript
// 消息存储结构（内存）
{
  byAgent: Map<agentId, Message[]>,  // 按智能体分组的消息
  byId: Map<messageId, Message>,     // 按 ID 索引的消息
}

// 持久化目录结构: {runtimeDir}/web/messages/
// 文件命名: {agentId}.jsonl
// 文件格式: JSON Lines（每行一条 JSON 消息）
//
// 示例目录结构:
// {runtimeDir}/web/messages/
// ├── root.jsonl
// ├── user.jsonl
// ├── efb31391-c08b-4e62-b390-d49d7797d1c8.jsonl
// └── ...
//
// 文件内容示例:
// {"id":"...","from":"user","to":"root","taskId":"...","payload":{...},"createdAt":"..."}
// {"id":"...","from":"root","to":"user","taskId":"...","payload":{...},"createdAt":"..."}
```

### 消息持久化策略

1. **文件格式**: JSON Lines（.jsonl），每行一条消息，便于追加写入
2. **文件分割**: 按智能体 ID 分割文件，每个智能体一个文件
3. **双向写入**: 每条消息同时写入发送者和接收者的文件（如果不同）
4. **写入方式**: 追加模式写入，无需重写整个文件
5. **按需加载**: 查询某智能体消息时只需读取该智能体的文件
6. **容错处理**: 单行解析失败时跳过该行，继续加载其他消息

## 数据模型

### 智能体（Agent）
```javascript
{
  id: string,           // 智能体 ID
  roleId: string,       // 岗位 ID
  roleName: string,     // 岗位名称
  parentAgentId: string,// 父智能体 ID
  createdAt: string,    // 创建时间（ISO 格式）
  status: string,       // 状态：active | terminated
  terminatedAt?: string // 终止时间
}
```

### 消息（Message）
```javascript
{
  id: string,           // 消息 ID
  from: string,         // 发送者智能体 ID
  to: string,           // 接收者智能体 ID
  taskId: string,       // 任务 ID
  payload: object,      // 消息内容
  createdAt: string     // 创建时间（ISO 格式）
}
```

### 岗位（Role）
```javascript
{
  id: string,           // 岗位 ID
  name: string,         // 岗位名称
  rolePrompt: string,   // 岗位提示词
  createdBy: string,    // 创建者智能体 ID
  createdAt: string,    // 创建时间
  agentCount: number    // 该岗位的智能体数量
}
```

### 组织树节点（OrgTreeNode）
```javascript
{
  id: string,           // 智能体 ID
  roleName: string,     // 岗位名称
  children: OrgTreeNode[] // 子节点
}
```

## 正确性属性

*正确性属性是系统在所有有效执行中都应保持为真的特征或行为——本质上是关于系统应该做什么的形式化陈述。属性作为人类可读规范和机器可验证正确性保证之间的桥梁。*

### 属性 1: 智能体列表排序正确性
*对于任意*智能体列表，当按创建时间升序排序时，列表中每个智能体的创建时间应小于或等于其后一个智能体的创建时间
**验证: 需求 1.3**

### 属性 2: 岗位筛选结果正确性
*对于任意*智能体列表和筛选关键词，筛选结果中的每个智能体的岗位名称都应包含该关键词（不区分大小写）
**验证: 需求 2.2, 2.4**

### 属性 3: 岗位智能体计数正确性
*对于任意*智能体列表，按岗位分组后，每个岗位的智能体数量应等于该岗位在原列表中出现的次数
**验证: 需求 3.2**

### 属性 4: 消息过滤正确性
*对于任意*消息列表和智能体 ID，过滤后的消息列表中每条消息的 from 或 to 字段应等于该智能体 ID
**验证: 需求 4.1**

### 属性 5: 消息时间排序正确性
*对于任意*消息列表，按时间排序后，列表中每条消息的创建时间应小于或等于其后一条消息的创建时间
**验证: 需求 4.8**

### 属性 6: 消息渲染完整性
*对于任意*消息对象，渲染后的输出应包含发送者 ID 和时间戳信息
**验证: 需求 4.4**

### 属性 7: 组织树结构正确性
*对于任意*智能体列表，生成的组织树中每个节点的 parentAgentId 应与其在树中的父节点 ID 一致
**验证: 需求 3.1**

### 属性 8: API 响应格式正确性
*对于任意* GET /api/agents 请求，响应应包含 agents 数组，且每个智能体对象应包含 id、roleId、roleName、createdAt 字段
**验证: 需求 9.1**

### 属性 9: 静态文件服务正确性
*对于任意*存在于 web 文件夹中的文件路径，请求该路径应返回对应文件的内容
**验证: 需求 8.1**

### 属性 10: 消息持久化往返正确性
*对于任意*消息对象，追加写入后再从文件加载应能正确解析出该消息
**验证: 需求 10.1, 10.3, 10.5**

## 错误处理

### 前端错误处理
1. **API 请求失败**: 显示错误提示，保持当前状态，允许重试
2. **消息发送失败**: 显示错误通知，保留输入内容
3. **WebSocket 断开**: 回退到轮询模式，显示连接状态指示器

### 后端错误处理
1. **日志文件不存在**: 返回空消息列表
2. **JSON 解析失败**: 跳过无效条目，记录警告日志
3. **智能体不存在**: 返回 404 错误

## 测试策略

### 单元测试
- 测试排序函数的正确性
- 测试筛选函数的正确性
- 测试消息过滤函数的正确性
- 测试组织树构建函数的正确性
- 测试 API 响应格式

### 属性测试
使用 fast-check 库进行属性测试：
- 每个属性测试运行至少 100 次迭代
- 测试标签格式: **功能: agent-web-viewer, 属性 N: 属性描述**

### 集成测试
- 测试前端与后端 API 的交互
- 测试消息发送和接收流程
- 测试实时更新功能

## 文件结构

```
web/
├── index.html          # 主页面
├── css/
│   └── style.css       # 样式文件
├── js/
│   ├── app.js          # 主应用逻辑
│   ├── api.js          # API 调用封装
│   ├── components/
│   │   ├── agent-list.js    # 智能体列表组件
│   │   ├── chat-panel.js    # 对话面板组件
│   │   ├── overview.js      # 总览面板组件
│   │   └── message-modal.js # 消息详情弹窗组件
│   └── utils/
│       ├── sort.js     # 排序工具函数
│       ├── filter.js   # 筛选工具函数
│       └── tree.js     # 树结构工具函数
└── assets/
    └── icons/          # 图标资源
```
