# 实现计划: 智能体 Web 查看器

## 概述

本实现计划将智能体 Web 查看器分解为可增量执行的任务，从后端 API 扩展开始，然后构建前端界面。使用纯 JavaScript 实现，所有代码使用中文注释。

## 任务列表

- [x] 1. 扩展 HTTP 服务器 API
  - [x] 1.1 添加消息存储和持久化功能
    - 在 HTTPServer 类中添加 `_messagesByAgent` Map 用于按智能体分组
    - 添加 `_messagesById` Map 用于按 ID 快速查找（去重）
    - 添加 `_runtimeDir` 属性存储运行时数据目录路径
    - 实现 `_loadMessagesForAgent(agentId)` 方法从 .jsonl 文件加载指定智能体的消息
    - 实现 `_appendMessageToFile(agentId, message)` 方法追加消息到智能体的 .jsonl 文件
    - 修改 `setSociety` 方法，监听所有消息并持久化（同时写入发送者和接收者文件）
    - 使用 JSON Lines 格式（每行一条 JSON），按智能体 ID 分割文件
    - _需求: 9.3, 9.6, 10.1, 10.2, 10.3, 10.4, 10.5, 10.6, 10.7_
  - [x] 1.2 实现 GET /api/agents 端点
    - 从 OrgPrimitives 读取持久化的智能体数据
    - 返回所有智能体列表，包含 id、roleId、roleName、parentAgentId、createdAt、status
    - 包含 root 和 user 两个特殊智能体
    - _需求: 9.1, 8.5_
  - [x] 1.3 实现 GET /api/roles 端点
    - 从 OrgPrimitives 读取持久化的岗位数据
    - 返回所有岗位列表，包含智能体数量统计
    - _需求: 9.2_
  - [x] 1.4 实现 GET /api/messages/:agentId 端点
    - 返回指定智能体发送和接收的所有消息
    - 按时间顺序排序
    - _需求: 9.3_
  - [x] 1.5 实现 GET /api/org/tree 端点
    - 从 OrgPrimitives 读取持久化的智能体数据
    - 返回组织层级树结构
    - 以 root 为根节点构建树
    - _需求: 9.4_
  - [x] 1.6 添加静态文件服务
    - 处理 /web/* 路径的请求
    - 从 web 文件夹读取并返回文件内容
    - 设置正确的 Content-Type
    - _需求: 8.1, 8.4_

- [x] 2. 检查点 - 确保 API 端点正常工作
  - 确保所有测试通过，如有问题请询问用户

- [x] 3. 创建前端基础结构
  - [x] 3.1 创建 HTML 主页面
    - 创建 web/index.html
    - 包含左侧智能体列表面板和右侧对话面板的布局
    - 引入 CSS 和 JavaScript 文件
    - _需求: 1.1, 4.1_
  - [x] 3.2 创建 CSS 样式文件
    - 创建 web/css/style.css
    - 实现仿微信风格的布局和样式
    - 消息气泡样式：右侧绿色背景、左侧白色背景
    - _需求: 4.2, 4.3_
  - [x] 3.3 创建 API 调用模块
    - 创建 web/js/api.js
    - 封装所有 API 调用方法
    - _需求: 8.2, 8.3_

- [x] 4. 实现智能体列表面板
  - [x] 4.1 创建智能体列表组件
    - 创建 web/js/components/agent-list.js
    - 实现智能体列表渲染
    - 显示智能体 ID、岗位名称、创建时间
    - 区分 root、user 和其他智能体的样式
    - _需求: 1.1, 1.2, 1.5_
  - [x] 4.2 实现排序功能
    - 创建 web/js/utils/sort.js
    - 默认按创建时间升序排列
    - 添加排序按钮切换排序方式
    - _需求: 1.3, 1.4_
  - [x] 4.3 编写排序函数属性测试
    - **属性 1: 智能体列表排序正确性**
    - **验证: 需求 1.3**
  - [x] 4.4 实现岗位筛选功能
    - 创建 web/js/utils/filter.js
    - 添加搜索输入框
    - 支持部分匹配和大小写不敏感
    - _需求: 2.1, 2.2, 2.3, 2.4_
  - [x] 4.5 编写筛选函数属性测试
    - **属性 2: 岗位筛选结果正确性**
    - **验证: 需求 2.2, 2.4**
  - [x] 4.6 实现终止状态显示
    - 为已终止的智能体添加视觉指示器
    - _需求: 1.6_

- [x] 5. 实现对话面板
  - [x] 5.1 创建对话面板组件
    - 创建 web/js/components/chat-panel.js
    - 实现消息列表渲染
    - 当前智能体消息靠右绿色背景，其他消息靠左白色背景
    - _需求: 4.1, 4.2, 4.3_
  - [x] 5.2 实现消息显示
    - 显示发送者 ID（作为可点击链接）和时间戳
    - 按时间顺序显示消息
    - _需求: 4.4, 4.5, 4.8_
  - [x] 5.3 编写消息过滤函数属性测试
    - **属性 4: 消息过滤正确性**
    - **验证: 需求 4.1**
  - [x] 5.4 编写消息排序函数属性测试
    - **属性 5: 消息时间排序正确性**
    - **验证: 需求 4.8**
  - [x] 5.5 实现消息来源链接跳转
    - 点击发送者链接跳转到发送者聊天界面
    - 自动滚动到该消息发送的位置
    - _需求: 4.6_
  - [x] 5.6 实现消息输入和发送
    - 添加文本输入框
    - 实现消息发送功能（以 user 身份）
    - 发送成功后清空输入框并显示消息
    - 发送失败显示错误通知
    - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 6. 实现消息详情弹窗
  - [x] 6.1 创建消息详情弹窗组件
    - 创建 web/js/components/message-modal.js
    - 在每条消息上添加详情按钮
    - _需求: 5.1_
  - [x] 6.2 实现弹窗内容显示
    - 显示消息 ID、taskId、payload、createdAt 等元数据
    - JSON payload 语法高亮显示
    - _需求: 5.2, 5.3, 5.4_
  - [x] 6.3 实现弹窗关闭功能
    - 点击弹窗外部或按 Escape 键关闭
    - _需求: 5.5_

- [x] 7. 实现总览面板
  - [x] 7.1 创建总览面板组件
    - 创建 web/js/components/overview.js
    - 创建 web/js/utils/tree.js
    - _需求: 3.1_
  - [x] 7.2 实现组织树状图
    - 显示智能体父子关系
    - 点击节点跳转到对话视图
    - _需求: 3.1, 3.3_
  - [x] 7.3 编写组织树构建函数属性测试
    - **属性 7: 组织树结构正确性**
    - **验证: 需求 3.1**
  - [x] 7.4 实现岗位统计显示
    - 按岗位分组显示智能体数量
    - _需求: 3.2_
  - [x] 7.5 编写岗位统计函数属性测试
    - **属性 3: 岗位智能体计数正确性**
    - **验证: 需求 3.2**

- [x] 8. 实现实时更新功能
  - [x] 8.1 创建主应用模块
    - 创建 web/js/app.js
    - 实现定时轮询（默认 2 秒）
    - _需求: 7.1_
  - [x] 8.2 实现消息增量更新
    - 新消息追加到对话中
    - 自动滚动到最新消息
    - _需求: 7.2, 4.7_
  - [x] 8.3 实现智能体列表更新
    - 新智能体自动添加到列表
    - _需求: 7.3_
  - [x] 8.4 实现新消息提示
    - 非选中智能体有新消息时显示视觉指示
    - _需求: 7.4_
  - [x] 8.5 实现总览面板实时更新
    - 新智能体创建或终止时更新树状图
    - _需求: 3.4_

- [x] 9. 检查点 - 最终验证
  - 所有测试通过，实现完成

## 备注

- 所有任务都必须执行，包括属性测试
- 每个任务引用了具体的需求编号以便追溯
- 检查点用于确保增量验证
- 属性测试验证核心逻辑的正确性
- 单元测试验证具体示例和边界情况
- 所有代码使用中文注释
