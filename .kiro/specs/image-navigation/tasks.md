# 工件管理器图片导航功能 - 任务列表

## 任务概述

本任务列表将图片导航功能的实现分解为可执行的具体任务。

## 任务状态说明
- `[ ]` 未开始
- `[-]` 进行中
- `[x]` 已完成

---

## 1. 创建 ThumbnailNavigator 组件

### 1.1 创建组件文件和基础结构
- [x] 创建 `web/js/components/thumbnail-navigator.js` 文件
- [x] 实现 `ThumbnailNavigator` 类的构造函数
- [x] 定义组件的属性（container, images, currentIndex, onSelect, thumbnailHeight）
- [x] 添加组件文档注释

**验收标准：**
- 文件创建成功
- 构造函数接收正确的参数
- 属性初始化正确

### 1.2 实现缩略图渲染逻辑
- [x] 实现 `render()` 方法
- [x] 实现 `_createThumbnailItem()` 方法
- [x] 实现 `_getImageUrl()` 方法，支持工作空间文件和普通工件
- [x] 添加图片懒加载（`loading="lazy"`）
- [x] 添加图片加载失败的占位符处理

**验收标准：**
- 缩略图正确渲染
- 图片 URL 正确生成
- 懒加载生效
- 加载失败显示占位符

### 1.3 实现交互功能
- [x] 实现缩略图点击事件处理
- [x] 实现 `setCurrentIndex()` 方法
- [x] 实现 `_updateActiveState()` 方法（高亮当前缩略图）
- [x] 实现 `setImages()` 方法（更新图片列表）

**验收标准：**
- 点击缩略图触发回调
- 当前缩略图正确高亮
- 图片列表更新后重新渲染

### 1.4 实现自动滚动功能
- [x] 实现 `scrollToCurrent()` 方法
- [x] 计算滚动位置使当前缩略图居中
- [x] 使用平滑滚动动画

**验收标准：**
- 切换图片后自动滚动到当前缩略图
- 滚动动画流畅
- 当前缩略图在可见区域居中

### 1.5 实现组件销毁
- [x] 实现 `destroy()` 方法
- [x] 清理 DOM 元素
- [x] 清理事件监听器

**验收标准：**
- 组件销毁后不占用内存
- 没有内存泄漏

---

## 2. 添加缩略图导航栏样式

### 2.1 定义 CSS 变量
- [x] 在 `web/css/style.css` 中添加 CSS 变量
- [x] 定义 `--thumbnail-height: 80px`
- [x] 定义 `--thumbnail-gap: 8px`
- [x] 定义 `--thumbnail-border-radius: 4px`
- [x] 定义 `--thumbnail-active-border-color: #007acc`
- [x] 定义 `--thumbnail-active-border-width: 3px`

**验收标准：**
- CSS 变量定义正确
- 可以通过修改变量调整样式

### 2.2 实现缩略图导航栏样式
- [x] 添加 `.thumbnail-navigator` 样式
- [x] 添加 `.thumbnail-list` 样式（flex 布局，单行横向）
- [x] 添加 `.thumbnail-item` 样式
- [x] 添加 `.thumbnail-item.active` 样式（高亮边框）
- [x] 添加 `.thumbnail-item:hover` 样式
- [x] 添加 `.thumbnail-item img` 样式

**验收标准：**
- 缩略图单行横向排列
- 支持横向滚动
- 当前缩略图有明显高亮
- 悬停效果正常

---

## 3. 修改 ArtifactManager 添加图片导航逻辑

### 3.1 添加图片导航相关属性
- [x] 在构造函数中添加 `this.currentImageIndex = -1`
- [x] 添加 `this.imageList = []`
- [x] 添加 `this.thumbnailNavigator = null`

**验收标准：**
- 属性初始化正确

### 3.2 实现图片列表管理方法
- [x] 实现 `_getFilteredImages()` 方法
- [x] 过滤出所有图片类型的工件
- [x] 考虑当前的搜索和过滤条件
- [x] 区分工作空间模式和工件模式

**验收标准：**
- 正确获取过滤后的图片列表
- 搜索和过滤条件生效
- 工作空间模式和工件模式分别处理

### 3.3 实现图片切换核心方法
- [x] 实现 `_navigateToImage(index)` 方法
- [x] 边界检查
- [x] 加载目标图片数据
- [x] 更新查看器显示
- [x] 更新缩略图导航器
- [x] 更新元数据和"查看来源"按钮
- [x] 添加错误处理

**验收标准：**
- 切换图片流畅
- 图片正确加载和显示
- 缩略图高亮正确更新
- 错误情况有提示

### 3.4 实现上一张/下一张方法
- [x] 实现 `_navigateToPreviousImage()` 方法
- [x] 实现 `_navigateToNextImage()` 方法
- [x] 实现循环切换逻辑（第一张 ← 最后一张，最后一张 → 第一张）

**验收标准：**
- 上一张/下一张切换正确
- 循环切换正常工作
- 边界情况处理正确

### 3.5 实现导航状态更新方法
- [x] 实现 `_updateImageNavigation()` 方法
- [x] 获取最新的图片列表
- [x] 找到当前工件在列表中的索引
- [x] 更新缩略图导航器

**验收标准：**
- 图片列表变化后导航状态正确更新
- 当前索引计算正确

---

## 4. 添加键盘导航功能

### 4.1 实现键盘事件处理
- [x] 实现 `_handleImageNavigationKeys(event)` 方法
- [x] 检查是否在查看图片状态
- [x] 处理左方向键（上一张）
- [x] 处理右方向键（下一张）
- [x] 阻止默认行为

**验收标准：**
- 左右方向键切换图片
- 只在查看图片时响应
- 不影响其他快捷键

### 4.2 绑定键盘事件
- [x] 在 `_attachEventListeners()` 中绑定 keydown 事件
- [x] 确保事件只在查看器打开时生效

**验收标准：**
- 键盘导航正常工作
- 不与其他快捷键冲突

---

## 5. 添加左右箭头按钮

### 5.1 实现箭头按钮创建方法
- [x] 实现 `_createNavigationArrows()` 方法
- [x] 创建左箭头按钮
- [x] 创建右箭头按钮
- [x] 绑定点击事件
- [x] 添加 title 属性

**验收标准：**
- 箭头按钮正确创建
- 点击事件正常触发

### 5.2 添加箭头按钮样式
- [x] 添加 `.image-navigation-arrows` 样式
- [x] 添加 `.nav-arrow` 样式
- [x] 添加 `.nav-arrow-left` 和 `.nav-arrow-right` 位置样式
- [x] 添加 `.nav-arrow:hover` 样式
- [x] 添加 `.single-image .nav-arrow` 隐藏样式

**验收标准：**
- 箭头按钮显示在图片两侧
- 半透明背景
- 悬停时高亮
- 只有一张图片时隐藏

---

## 6. 集成导航功能到现有流程

### 6.1 修改 openArtifact 方法
- [x] 在打开工件后调用 `_updateImageNavigation()`
- [x] 判断是否为图片类型
- [x] 显示或隐藏导航组件

**验收标准：**
- 打开图片时显示导航
- 打开非图片时不显示导航

### 6.2 修改 _displayArtifact 方法
- [x] 为图片类型创建专门的容器结构
- [x] 集成 ThumbnailNavigator 组件
- [x] 添加左右箭头按钮
- [x] 只在多张图片时显示导航组件

**验收标准：**
- 图片查看器正确显示
- 缩略图导航栏正确渲染
- 箭头按钮正确显示
- 单张图片时不显示导航

### 6.3 修改 closeViewer 方法
- [x] 销毁 ThumbnailNavigator 组件
- [x] 重置图片导航相关状态
- [x] 清理事件监听器

**验收标准：**
- 关闭查看器后组件正确销毁
- 没有内存泄漏

### 6.4 修改 _applyFilters 方法
- [x] 过滤条件变化后更新图片导航
- [x] 调用 `_updateImageNavigation()`

**验收标准：**
- 过滤后导航正确更新
- 当前图片索引正确计算

---

## 7. 性能优化

### 7.1 实现图片预加载
- [ ] 实现 `_preloadAdjacentImages()` 方法
- [ ] 预加载前一张图片
- [ ] 预加载后一张图片
- [ ] 在切换图片后调用预加载

**验收标准：**
- 相邻图片预加载
- 切换更流畅

### 7.2 优化缩略图加载
- [ ] 确认懒加载生效
- [ ] 测试大量图片（50+）的性能
- [ ] 如需要，实现虚拟滚动

**验收标准：**
- 大量图片时性能良好
- 内存占用合理

---

## 8. 测试

### 8.1 功能测试
- [ ] 测试缩略图点击切换
- [ ] 测试键盘左右键切换
- [ ] 测试箭头按钮切换
- [ ] 测试循环切换（第一张 ← 最后一张）
- [ ] 测试自动滚动到当前缩略图
- [ ] 测试缩略图高亮状态

**验收标准：**
- 所有导航方式正常工作
- 循环切换正确
- 视觉反馈正确

### 8.2 边界测试
- [ ] 测试只有一张图片的情况
- [ ] 测试没有图片的情况
- [ ] 测试图片加载失败的情况
- [ ] 测试 API 请求失败的情况

**验收标准：**
- 边界情况处理正确
- 错误提示友好

### 8.3 过滤测试
- [ ] 测试搜索过滤后的导航
- [ ] 测试扩展名过滤后的导航
- [ ] 测试工作空间模式下的导航
- [ ] 测试过滤条件变化后的导航更新

**验收标准：**
- 过滤后导航只在过滤结果中进行
- 过滤条件变化后导航正确更新

### 8.4 兼容性测试
- [ ] 测试不影响非图片类型工件的查看
- [ ] 测试 ESC 键仍能关闭查看器
- [ ] 测试其他快捷键不受影响
- [ ] 测试不同浏览器（Chrome, Firefox, Edge）

**验收标准：**
- 不影响现有功能
- 快捷键不冲突
- 跨浏览器兼容

### 8.5 性能测试
- [ ] 测试 50+ 图片的加载性能
- [ ] 测试切换流畅度
- [ ] 测试内存占用
- [ ] 测试滚动性能

**验收标准：**
- 大量图片时性能良好
- 切换流畅无卡顿
- 内存占用合理

### 8.6 样式测试
- [ ] 测试 CSS 变量可以调整缩略图尺寸
- [ ] 测试箭头按钮样式
- [ ] 测试缩略图高亮样式
- [ ] 测试响应式布局

**验收标准：**
- 修改 CSS 变量可以调整样式
- 视觉效果符合设计
- 不同屏幕尺寸下正常显示

---

## 9. 文档和清理

### 9.1 代码注释
- [ ] 为所有新增方法添加文档注释
- [ ] 注释关键算法和逻辑
- [ ] 注释复杂的 CSS 样式

**验收标准：**
- 代码注释完整
- 注释清晰易懂

### 9.2 更新相关文档
- [ ] 更新 `web/js/components/` 目录的说明文档（如果有）
- [ ] 更新用户使用说明（如果需要）

**验收标准：**
- 文档更新完整

### 9.3 代码审查和优化
- [ ] 检查代码风格一致性
- [ ] 检查是否有重复代码
- [ ] 检查是否有性能问题
- [ ] 检查是否有安全问题

**验收标准：**
- 代码质量良好
- 符合项目规范

---

## 任务依赖关系

```
1. ThumbnailNavigator 组件
   ├─ 1.1 基础结构
   ├─ 1.2 渲染逻辑
   ├─ 1.3 交互功能
   ├─ 1.4 自动滚动
   └─ 1.5 组件销毁

2. 样式
   ├─ 2.1 CSS 变量
   └─ 2.2 缩略图样式

3. ArtifactManager 修改
   ├─ 3.1 添加属性
   ├─ 3.2 图片列表管理
   ├─ 3.3 切换核心方法
   ├─ 3.4 上一张/下一张
   └─ 3.5 导航状态更新

4. 键盘导航
   ├─ 4.1 事件处理
   └─ 4.2 绑定事件

5. 箭头按钮
   ├─ 5.1 创建方法
   └─ 5.2 样式

6. 集成
   ├─ 6.1 修改 openArtifact
   ├─ 6.2 修改 _displayArtifact
   ├─ 6.3 修改 closeViewer
   └─ 6.4 修改 _applyFilters

7. 性能优化
   ├─ 7.1 图片预加载
   └─ 7.2 缩略图优化

8. 测试
   ├─ 8.1 功能测试
   ├─ 8.2 边界测试
   ├─ 8.3 过滤测试
   ├─ 8.4 兼容性测试
   ├─ 8.5 性能测试
   └─ 8.6 样式测试

9. 文档和清理
   ├─ 9.1 代码注释
   ├─ 9.2 更新文档
   └─ 9.3 代码审查
```

## 建议的实现顺序

1. **第一阶段：基础组件**（任务 1, 2）
   - 创建 ThumbnailNavigator 组件
   - 添加样式

2. **第二阶段：核心逻辑**（任务 3）
   - 修改 ArtifactManager
   - 实现图片切换逻辑

3. **第三阶段：交互功能**（任务 4, 5）
   - 添加键盘导航
   - 添加箭头按钮

4. **第四阶段：集成**（任务 6）
   - 集成到现有流程
   - 确保所有功能协同工作

5. **第五阶段：优化和测试**（任务 7, 8）
   - 性能优化
   - 全面测试

6. **第六阶段：完善**（任务 9）
   - 文档和清理
   - 代码审查

## 预估工作量

- **第一阶段**：2-3 小时
- **第二阶段**：3-4 小时
- **第三阶段**：1-2 小时
- **第四阶段**：2-3 小时
- **第五阶段**：2-3 小时
- **第六阶段**：1-2 小时

**总计**：约 11-17 小时

## 注意事项

1. 每完成一个任务，立即测试该功能
2. 遇到问题及时记录和解决
3. 保持代码提交的原子性
4. 定期进行代码审查
5. 注意性能和内存占用
6. 确保不影响现有功能
